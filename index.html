<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿå…‰æ©Ÿ - é£Ÿæºç´¢å¼• | Foodie-Graph & Source Index</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            transition: background-color 0.5s ease, color 0.5s ease;
            min-height: 100vh;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* å°è¦½åˆ— */
        nav {
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease;
        }

        nav .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 4rem;
            padding: 0 1.5rem;
        }

        nav h1 {
            font-family: 'Noto Serif TC', serif;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: white;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .nav-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .nav-btn:hover, .nav-btn.active {
            background-color: rgba(255,255,255,0.2);
        }

        .season-selector {
            display: flex;
            gap: 0.5rem;
        }

        .season-btn {
            width: 2.5rem;
            height: 2.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 50%;
            font-size: 1.25rem;
            transition: all 0.2s;
        }

        .season-btn:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .season-btn.active {
            background-color: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* æ‰‹æ©Ÿé¸å–® */
        .mobile-menu-btn {
            display: none;
            width: 2.5rem;
            height: 2.5rem;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 16rem;
            z-index: 999;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            color: white;
            padding: 1.5rem;
        }

        .mobile-menu.open {
            transform: translateX(0);
        }

        .mobile-menu .close-btn {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            margin-bottom: 1.5rem;
        }

        .mobile-menu .menu-item {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            border-radius: 0.5rem;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .mobile-menu .menu-item:hover {
            background-color: rgba(255,255,255,0.1);
        }

        /* ä¸»è¦å…§å®¹ */
        main {
            padding: 2rem 1rem;
            min-height: calc(100vh - 10rem);
        }

        /* å¡ç‰‡ */
        .card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        /* æŒ‰éˆ• */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            color: white;
        }

        .btn-outline {
            background: white;
            border: 2px solid;
        }

        .btn-danger {
            background: white;
            border: 2px solid #ef4444;
            color: #ef4444;
        }

        .btn-danger:hover {
            background: #fef2f2;
        }

        /* è¼¸å…¥æ¡† */
        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-family: 'Noto Sans TC', sans-serif;
            transition: border-color 0.2s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        textarea {
            resize: vertical;
            min-height: 6rem;
        }

        /* Grid ç³»çµ± */
        .grid {
            display: grid;
            gap: 1rem;
        }

        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        /* å·¥å…·é¡ */
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }

        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }

        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }

        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }

        .opacity-70 { opacity: 0.7; }
        .hidden { display: none !important; }

        /* ç•¶å­£æ¨™ç±¤ */
        .seasonal-badge {
            position: absolute;
            top: 0;
            right: 0;
            padding: 0.25rem 0.75rem;
            border-radius: 0 1rem 0 0.75rem;
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 64rem;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
            border-radius: 1rem 1rem 0 0;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .close-modal {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        .close-modal:hover {
            background: #f3f4f6;
        }

        /* Footer */
        footer {
            margin-top: 5rem;
            padding: 1.5rem;
            text-align: center;
            font-size: 0.875rem;
            border-top: 1px solid;
        }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            nav h1 {
                font-size: 1.25rem;
            }

            .nav-links {
                display: none;
            }

            .mobile-menu-btn {
                display: block;
            }

            .mobile-menu {
                display: block;
            }

            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }

            @media (min-width: 640px) {
                .grid-2 {
                    grid-template-columns: repeat(2, 1fr);
                }
            }
        }

        /* æ¨™ç±¤èˆ‡ç¯©é¸å™¨ */
        .filter-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            background: #f3f4f6;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .filter-btn.active {
            color: white;
        }

        .tag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* æ­¥é©Ÿç·¨è™Ÿ */
        .step-number {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            flex-shrink: 0;
        }

        /* è¡¨å–®é …ç›® */
        .form-item {
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        /* Icon placeholders */
        .icon {
            width: 1.25rem;
            height: 1.25rem;
            display: inline-block;
        }

        /* æœå°‹æ¡† */
        .search-wrapper {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
        }

        .search-input {
            padding-left: 2.5rem;
        }

        /* å±•é–‹/æ”¶åˆ */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.open {
            max-height: 5000px;
        }

        /* çµ±è¨ˆæ•¸å­— */
        .stat-box {
            text-align: center;
            padding: 1rem;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <!-- å°è¦½åˆ— -->
    <nav id="navbar">
        <div class="nav-content">
            <div class="flex items-center gap-2">
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                    â˜°
                </button>
                <h1>
                    <span id="season-icon">ğŸŒ±</span>
                    é£Ÿå…‰æ©Ÿ - é£Ÿæºç´¢å¼•
                </h1>
            </div>
            
            <div class="nav-links">
                <button class="nav-btn active" onclick="setView('home')" data-view="home">é¦–é </button>
                <button class="nav-btn" onclick="setView('ingredients')" data-view="ingredients">é£Ÿæåº«</button>
                <button class="nav-btn" onclick="setView('recipes')" data-view="recipes">é£Ÿè­œåº«</button>
                <button class="nav-btn" onclick="setView('organizer')" data-view="organizer">é£Ÿè­œæ•´ç†</button>
                <button class="nav-btn" onclick="setView('settings')" data-view="settings">âš™ï¸</button>
            </div>

            <div class="season-selector">
                <button class="season-btn active" onclick="setSeason('spring')" data-season="spring" title="æ˜¥å­£">ğŸŒ±</button>
                <button class="season-btn" onclick="setSeason('summer')" data-season="summer" title="å¤å­£">â˜€ï¸</button>
                <button class="season-btn" onclick="setSeason('autumn')" data-season="autumn" title="ç§‹å­£">ğŸ</button>
                <button class="season-btn" onclick="setSeason('winter')" data-season="winter" title="å†¬å­£">â„ï¸</button>
            </div>
        </div>
    </nav>

    <!-- æ‰‹æ©Ÿé¸å–® -->
    <div class="mobile-menu" id="mobileMenu">
        <button class="close-btn" onclick="toggleMobileMenu()">âœ•</button>
        <button class="menu-item" onclick="setView('home'); toggleMobileMenu();">é¦–é </button>
        <button class="menu-item" onclick="setView('ingredients'); toggleMobileMenu();">é£Ÿæåº«</button>
        <button class="menu-item" onclick="setView('recipes'); toggleMobileMenu();">é£Ÿè­œåº«</button>
        <button class="menu-item" onclick="setView('organizer'); toggleMobileMenu();">é£Ÿè­œæ•´ç†</button>
        <button class="menu-item" onclick="setView('settings'); toggleMobileMenu();">è¨­å®š</button>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="container">
        <!-- é¦–é  -->
        <div id="home-view" class="view-content"></div>
        
        <!-- é£Ÿæåº« -->
        <div id="ingredients-view" class="view-content hidden"></div>
        
        <!-- é£Ÿè­œåº« -->
        <div id="recipes-view" class="view-content hidden"></div>
        
        <!-- é£Ÿè­œæ•´ç† -->
        <div id="organizer-view" class="view-content hidden"></div>
        
        <!-- è¨­å®š -->
        <div id="settings-view" class="view-content hidden"></div>
    </main>

    <!-- Footer -->
    <footer id="footer">
        <p class="mb-2">Designed by Ching & Claude | v1.3.1</p>
        <p class="text-sm opacity-70">Â© 2026 é£Ÿå…‰æ©Ÿ - é£Ÿæºç´¢å¼•</p>
    </footer>

    <!-- Modal å®¹å™¨ -->
    <div id="modal-container"></div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        const VERSION = 'v1.3.1';
        const CATEGORIES = ['ç¦½è‚‰é¡', 'æµ·é®®é¡', 'è›‹è±†é¡', 'è”¬èœé¡', 'æ°´æœé¡', 'é£²å“é¡', 'æ¾±ç²‰ä¸»é£Ÿé¡', 'é¦™æ–™èª¿å‘³å“é¡'];
        const MONTHS = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
        
        // é£Ÿæå–®ä½
        const INGREDIENT_UNITS = [
            'å€‹ / é¡† / éš» (pcs.)',
            'æ ¹ / æ¢ / æ”¯ (stalk/strip)',
            'ç‰‡ (slice)',
            'ç“£ (clove)',
            'æŠŠ (bunch/handful)',
            'å¡Š (block/chunk)',
            'è¢‹ / åŒ… (pack/bag)',
            'å…¶ä»–'
        ];
        
        // èª¿å‘³æ–™å–®ä½
        const SEASONING_UNITS = [
            'å…¬å…‹ (g)',
            'å…¬æ–¤ (kg)',
            'å°æ–¤ (catty)',
            'æ¯«å‡ (ml)',
            'å…¬å‡ (L)',
            'å¤§åŒ™ (tbsp/T.) â‰ˆ15ml',
            'å°åŒ™ (tsp/t.) â‰ˆ5ml',
            'é‡æ¯ (cup) â‰ˆ240ml',
            'æ»´ (drop)',
            'é©é‡ (as needed)',
            'äº›è¨± (pinch)',
            'å…¶ä»–'
        ];

        const THEMES = {
            spring: {
                name: 'æ˜¥å­£ Spring',
                icon: 'ğŸŒ±',
                primary: '#88C057',
                background: '#F0F7E6',
                secondary: '#E9D36F',
                text: '#3B4536',
                months: [3, 4, 5]
            },
            summer: {
                name: 'å¤å­£ Summer',
                icon: 'â˜€ï¸',
                primary: '#FF7F50',
                background: '#F0F8FF',
                secondary: '#FFD700',
                text: '#2C3E50',
                months: [6, 7, 8]
            },
            autumn: {
                name: 'ç§‹å­£ Autumn',
                icon: 'ğŸ',
                primary: '#D2691E',
                background: '#FAF3E0',
                secondary: '#A0522D',
                text: '#4A3B2A',
                months: [9, 10, 11]
            },
            winter: {
                name: 'å†¬å­£ Winter',
                icon: 'â„ï¸',
                primary: '#5F9EA0',
                background: '#F5F7FA',
                secondary: '#CD5C5C',
                text: '#2F4F4F',
                months: [12, 1, 2]
            }
        };

        // ç‹€æ…‹ç®¡ç†
        let state = {
            currentSeason: 'spring',
            currentView: 'home',
            ingredients: [],
            recipes: [],
            searchTerm: '',
            selectedMonth: null,
            selectedCategory: null,
            shareCode: null
        };

        // åˆå§‹åŒ–
        function init() {
            loadData();
            const currentMonth = new Date().getMonth() + 1;
            state.currentSeason = getSeasonByMonth(currentMonth);
            setSeason(state.currentSeason);
            renderCurrentView();
        }

        // æ ¹æ“šæœˆä»½åˆ¤æ–·å­£ç¯€
        function getSeasonByMonth(month) {
            if ([3, 4, 5].includes(month)) return 'spring';
            if ([6, 7, 8].includes(month)) return 'summer';
            if ([9, 10, 11].includes(month)) return 'autumn';
            return 'winter';
        }

        // è¼‰å…¥è³‡æ–™
        function loadData() {
            const savedIngredients = localStorage.getItem('foodie-ingredients');
            const savedRecipes = localStorage.getItem('foodie-recipes');
            const savedShareCode = localStorage.getItem('foodie-share-code');
            
            if (savedIngredients) state.ingredients = JSON.parse(savedIngredients);
            if (savedRecipes) state.recipes = JSON.parse(savedRecipes);
            if (savedShareCode) state.shareCode = savedShareCode;
        }

        // å„²å­˜è³‡æ–™
        function saveData() {
            localStorage.setItem('foodie-ingredients', JSON.stringify(state.ingredients));
            localStorage.setItem('foodie-recipes', JSON.stringify(state.recipes));
        }

        // è¨­å®šå­£ç¯€ä¸»é¡Œ
        function setSeason(season) {
            state.currentSeason = season;
            const theme = THEMES[season];
            
            document.body.style.backgroundColor = theme.background;
            document.body.style.color = theme.text;
            document.getElementById('navbar').style.backgroundColor = theme.primary + 'E6';
            document.getElementById('season-icon').textContent = theme.icon;
            document.getElementById('mobileMenu').style.backgroundColor = theme.primary;
            document.getElementById('footer').style.borderColor = theme.primary + '30';
            
            document.documentElement.style.setProperty('--primary-color', theme.primary);
            document.documentElement.style.setProperty('--secondary-color', theme.secondary);
            
            document.querySelectorAll('.season-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.season === season);
            });
            
            renderCurrentView();
        }

        // åˆ‡æ›è¦–åœ–
        function setView(view) {
            state.currentView = view;
            state.searchTerm = '';
            state.selectedMonth = null;
            state.selectedCategory = null;
            
            document.querySelectorAll('.view-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`${view}-view`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            
            renderCurrentView();
        }

        // æ¸²æŸ“ç•¶å‰è¦–åœ–
        function renderCurrentView() {
            switch(state.currentView) {
                case 'home':
                    renderHomeView();
                    break;
                case 'ingredients':
                    renderIngredientsView();
                    break;
                case 'recipes':
                    renderRecipesView();
                    break;
                case 'organizer':
                    renderOrganizerView();
                    break;
                case 'settings':
                    renderSettingsView();
                    break;
            }
        }

        // æ¸²æŸ“é¦–é 
        function renderHomeView() {
            const theme = THEMES[state.currentSeason];
            const currentMonth = new Date().getMonth() + 1;
            
            // æ ¹æ“šç•¶å‰é¸æ“‡çš„å­£ç¯€ç¯©é¸é£Ÿæï¼ˆè€Œéç•¶å‰æœˆä»½ï¼‰
            const seasonMonths = THEMES[state.currentSeason].months;
            const seasonalIngredients = state.ingredients.filter(ing => 
                ing.seasons.some(month => seasonMonths.includes(month))
            );
            
            // ç¯©é¸åŒ…å«ç•¶å­£é£Ÿæçš„é£Ÿè­œ
            const seasonalRecipes = state.recipes.filter(recipe => {
                return recipe.ingredients.some(ing => {
                    const matchedIngredient = state.ingredients.find(i => 
                        i.name.toLowerCase() === ing.name.toLowerCase()
                    );
                    return matchedIngredient && matchedIngredient.seasons.some(m => seasonMonths.includes(m));
                });
            });

            const html = `
                <div style="margin-top: 2rem;">
                    <!-- æ­¡è¿å¡ç‰‡ -->
                    <div class="card text-center mb-8">
                        <h2 style="font-family: 'Noto Serif TC', serif; font-size: 2.25rem; color: ${theme.primary}; margin-bottom: 1rem;">
                            ${theme.name} ${theme.icon}
                        </h2>
                        <p class="text-lg mb-6">æ­¡è¿ä¾†åˆ°æ‚¨çš„å°ˆå±¬é£Ÿæèˆ‡é£Ÿè­œè³‡æ–™åº«</p>
                        <div class="flex justify-between gap-4" style="max-width: 36rem; margin: 0 auto; flex-wrap: wrap;">
                            <div class="stat-box">
                                <div class="stat-number" style="color: ${theme.primary}">${state.ingredients.length}</div>
                                <div class="stat-label">é£Ÿæç¸½æ•¸</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number" style="color: ${theme.primary}">${state.recipes.length}</div>
                                <div class="stat-label">é£Ÿè­œç¸½æ•¸</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number" style="color: ${theme.secondary}">${seasonalIngredients.length}</div>
                                <div class="stat-label">${theme.name.split(' ')[0]}é£Ÿæ</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number" style="color: ${theme.secondary}">${seasonalRecipes.length}</div>
                                <div class="stat-label">${theme.name.split(' ')[0]}é£Ÿè­œ</div>
                            </div>
                        </div>
                    </div>

                    ${seasonalIngredients.length > 0 ? `
                    <!-- ç•¶å­£æ¨è–¦ -->
                    <div class="mb-8">
                        <h3 class="text-2xl font-bold mb-4 flex items-center gap-2" style="font-family: 'Noto Serif TC', serif;">
                            <span>ğŸŒ¿</span>
                            ${theme.name.split(' ')[0]}é£Ÿææ¨è–¦
                        </h3>
                        <div class="grid grid-3">
                            ${seasonalIngredients.slice(0, 6).map(ing => `
                                <div class="card" style="position: relative;">
                                    <div class="seasonal-badge" style="background-color: ${theme.secondary};">
                                        ç•¶å­£
                                    </div>
                                    <h4 class="font-bold text-lg mb-2" style="padding-right: 3rem;">${ing.name}</h4>
                                    <p class="text-sm opacity-70">${ing.category}</p>
                                    ${ing.nutrition || ing.cooking || ing.selection ? `
                                        <p class="text-sm mt-2" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                            ${ing.nutrition || ing.cooking || ing.selection}
                                        </p>
                                    ` : ing.notes ? `
                                        <p class="text-sm mt-2" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${ing.notes}</p>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${seasonalRecipes.length > 0 ? `
                    <!-- ç•¶å­£é£Ÿè­œæ¨è–¦ -->
                    <div class="mb-8">
                        <h3 class="text-2xl font-bold mb-4 flex items-center gap-2" style="font-family: 'Noto Serif TC', serif;">
                            <span>ğŸ“–</span>
                            ${theme.name.split(' ')[0]}é£Ÿè­œæ¨è–¦
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            ${seasonalRecipes.slice(0, 3).map(recipe => `
                                <div class="card" style="border-left: 4px solid ${theme.secondary}; cursor: pointer;" 
                                     onclick="setView('recipes'); setTimeout(() => { const recipeCard = document.querySelector('[onclick*=toggleRecipe\\\\(${recipe.id}\\\\)]'); if(recipeCard) { recipeCard.click(); recipeCard.scrollIntoView({behavior: 'smooth', block: 'center'}); } }, 100);">
                                    <h4 class="font-bold text-lg mb-1">${recipe.name}</h4>
                                    <p class="text-sm opacity-70">
                                        ${recipe.servings || 1} äººä»½ Â· ${recipe.ingredients.length} ç¨®é£Ÿæ
                                    </p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- å¿«é€Ÿæ“ä½œ -->
                    <div class="grid grid-2">
                        <button class="card" onclick="openIngredientForm()" style="border-left: 4px solid ${theme.primary}; cursor: pointer; text-align: center; padding: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.75rem;">â•</div>
                            <h3 class="font-bold text-xl">æ–°å¢é£Ÿæ</h3>
                        </button>
                        <button class="card" onclick="openRecipeForm()" style="border-left: 4px solid ${theme.secondary}; cursor: pointer; text-align: center; padding: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.75rem;">â•</div>
                            <h3 class="font-bold text-xl">æ–°å¢é£Ÿè­œ</h3>
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('home-view').innerHTML = html;
        }

        // æ¸²æŸ“é£Ÿæåº«
        function renderIngredientsView() {
            const theme = THEMES[state.currentSeason];
            const currentMonth = new Date().getMonth() + 1;
            
            // ç¯©é¸é£Ÿæï¼ˆæ”¯æ´å…¨æ–‡æœå°‹ï¼‰
            const filteredIngredients = state.ingredients.filter(ing => {
                const searchLower = state.searchTerm.toLowerCase();
                const matchSearch = !state.searchTerm || 
                    ing.name.toLowerCase().includes(searchLower) ||
                    ing.category.toLowerCase().includes(searchLower) ||
                    (ing.nutrition && ing.nutrition.toLowerCase().includes(searchLower)) ||
                    (ing.cooking && ing.cooking.toLowerCase().includes(searchLower)) ||
                    (ing.selection && ing.selection.toLowerCase().includes(searchLower)) ||
                    (ing.notes && ing.notes.toLowerCase().includes(searchLower));
                
                const matchMonth = !state.selectedMonth || ing.seasons.includes(state.selectedMonth);
                const matchCategory = !state.selectedCategory || ing.category === state.selectedCategory;
                return matchSearch && matchMonth && matchCategory;
            });

            const html = `
                <div style="margin-top: 2rem;">
                    <!-- æ¨™é¡Œ -->
                    <div class="flex justify-between items-center mb-6" style="flex-wrap: wrap; gap: 1rem;">
                        <h2 class="text-3xl font-bold" style="font-family: 'Noto Serif TC', serif;">
                            é£Ÿæåº« (${filteredIngredients.length})
                        </h2>
                        <button class="btn btn-primary" onclick="openIngredientForm()" style="background-color: ${theme.primary};">
                            â• æ–°å¢é£Ÿæ
                        </button>
                    </div>

                    <!-- æœå°‹èˆ‡ç¯©é¸ -->
                    <div class="card mb-6">
                        <!-- æ–‡å­—æœå°‹ -->
                        <div class="search-wrapper mb-4">
                            <span class="search-icon">ğŸ”</span>
                            <input type="text" class="search-input" placeholder="æœå°‹é£Ÿæåç¨±..." 
                                   value="${state.searchTerm}" oninput="handleSearch(this.value)">
                        </div>

                        <!-- æœˆä»½ç¯©é¸ -->
                        <div class="mb-4">
                            <label class="form-label">å­£ç¯€ç¯©é¸</label>
                            <div class="flex gap-2" style="flex-wrap: wrap;">
                                <button class="filter-btn ${!state.selectedMonth ? 'active' : ''}" 
                                        onclick="setMonthFilter(null)"
                                        style="${!state.selectedMonth ? `background-color: ${theme.primary}; color: white;` : ''}">
                                    å…¨éƒ¨
                                </button>
                                ${MONTHS.map((month, idx) => `
                                    <button class="filter-btn ${state.selectedMonth === idx + 1 ? 'active' : ''}" 
                                            onclick="setMonthFilter(${idx + 1})"
                                            style="${state.selectedMonth === idx + 1 ? `background-color: ${theme.primary}; color: white;` : ''}">
                                        ${month}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <!-- åˆ†é¡ç¯©é¸ -->
                        <div>
                            <label class="form-label">åˆ†é¡ç¯©é¸</label>
                            <div class="flex gap-2" style="flex-wrap: wrap;">
                                <button class="filter-btn ${!state.selectedCategory ? 'active' : ''}" 
                                        onclick="setCategoryFilter(null)"
                                        style="${!state.selectedCategory ? `background-color: ${theme.primary}; color: white;` : ''}">
                                    å…¨éƒ¨
                                </button>
                                ${CATEGORIES.map(cat => `
                                    <button class="filter-btn ${state.selectedCategory === cat ? 'active' : ''}" 
                                            onclick="setCategoryFilter('${cat}')"
                                            style="${state.selectedCategory === cat ? `background-color: ${theme.primary}; color: white;` : ''}">
                                        ${cat}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- é£Ÿæåˆ—è¡¨ -->
                    ${filteredIngredients.length === 0 ? `
                        <div class="text-center" style="padding: 5rem 0; opacity: 0.5;">
                            <p class="text-lg">å°šç„¡é£Ÿæï¼Œé–‹å§‹æ–°å¢æ‚¨çš„ç¬¬ä¸€å€‹é£Ÿæå§ï¼</p>
                        </div>
                    ` : `
                        <div class="grid grid-3">
                            ${filteredIngredients.map(ing => renderIngredientCard(ing, theme, currentMonth)).join('')}
                        </div>
                    `}
                </div>
            `;

            document.getElementById('ingredients-view').innerHTML = html;
        }

        // æ¸²æŸ“é£Ÿæå¡ç‰‡
        function renderIngredientCard(ingredient, theme, currentMonth) {
            const isInSeason = ingredient.seasons.includes(currentMonth);
            
            return `
                <div class="card" style="position: relative;">
                    ${isInSeason ? `
                        <div class="seasonal-badge" style="background-color: ${theme.secondary};">
                            ${theme.icon} ç•¶å­£
                        </div>
                    ` : ''}
                    
                    <h3 class="font-bold text-xl mb-2" style="padding-right: ${isInSeason ? '4rem' : '0'};">${ingredient.name}</h3>
                    
                    <div style="margin-bottom: 0.5rem;">
                        <span class="tag" style="background-color: ${theme.primary}20; color: ${theme.primary};">
                            ${ingredient.category}
                        </span>
                    </div>
                    
                    <div class="flex items-center gap-2 mb-2" style="flex-wrap: wrap;">
                        <span class="text-sm opacity-70">ç››ç”¢å­£ç¯€ï¼š</span>
                        ${ingredient.seasons.sort((a, b) => a - b).map(m => `
                            <span class="tag" style="background-color: ${m === currentMonth ? theme.secondary + '30' : '#f0f0f0'}; 
                                                      color: ${m === currentMonth ? theme.secondary : theme.text};">
                                ${m}æœˆ
                            </span>
                        `).join('')}
                    </div>
                    
                    ${ingredient.nutrition || ingredient.cooking || ingredient.selection ? `
                        <div class="mt-3" style="padding: 0.75rem; border-radius: 0.5rem; background-color: ${theme.background};">
                            ${ingredient.nutrition ? `
                                <div class="${ingredient.cooking || ingredient.selection ? 'mb-2' : ''}">
                                    <div class="text-sm font-bold mb-1">ğŸ¥— ç‡Ÿé¤Šä¾†æº</div>
                                    <div class="text-sm">${ingredient.nutrition}</div>
                                </div>
                            ` : ''}
                            ${ingredient.cooking ? `
                                <div class="${ingredient.selection ? 'mb-2' : ''}">
                                    <div class="text-sm font-bold mb-1">ğŸ‘¨â€ğŸ³ çƒ¹é£ªæ–¹å¼</div>
                                    <div class="text-sm">${ingredient.cooking}</div>
                                </div>
                            ` : ''}
                            ${ingredient.selection ? `
                                <div>
                                    <div class="text-sm font-bold mb-1">âœ¨ æŒ‘é¸æŠ€å·§</div>
                                    <div class="text-sm">${ingredient.selection}</div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ingredient.notes ? `
                        <p class="text-sm mt-4" style="padding: 0.75rem; border-radius: 0.5rem; background-color: ${theme.background};">
                            ${ingredient.notes}
                        </p>
                    ` : ''}
                    
                    <div class="flex gap-2 mt-4">
                        <button class="btn btn-outline flex-1" onclick="openIngredientForm(${ingredient.id})" 
                                style="border-color: ${theme.primary}; color: ${theme.primary};">
                            âœï¸ ç·¨è¼¯
                        </button>
                        <button class="btn btn-danger" onclick="deleteIngredient(${ingredient.id})">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“é£Ÿè­œåº«
        function renderRecipesView() {
            const theme = THEMES[state.currentSeason];
            
            const filteredRecipes = state.recipes.filter(recipe => {
                if (!state.searchTerm) return true;
                
                const searchLower = state.searchTerm.toLowerCase();
                
                // æœå°‹é£Ÿè­œåç¨±
                if (recipe.name.toLowerCase().includes(searchLower)) return true;
                
                // æœå°‹é£Ÿæ
                if (recipe.ingredients.some(ing => 
                    ing.name.toLowerCase().includes(searchLower) ||
                    (ing.brand && ing.brand.toLowerCase().includes(searchLower)) ||
                    (ing.tips && ing.tips.toLowerCase().includes(searchLower))
                )) return true;
                
                // æœå°‹èª¿å‘³æ–™
                if (recipe.seasonings.some(s => 
                    s.name.toLowerCase().includes(searchLower) ||
                    (s.brand && s.brand.toLowerCase().includes(searchLower)) ||
                    (s.tips && s.tips.toLowerCase().includes(searchLower))
                )) return true;
                
                // æœå°‹æ­¥é©Ÿ
                if (recipe.steps.some(step => 
                    step.text.toLowerCase().includes(searchLower) ||
                    (step.tips && step.tips.toLowerCase().includes(searchLower))
                )) return true;
                
                return false;
            });

            const html = `
                <div style="margin-top: 2rem;">
                    <!-- æ¨™é¡Œ -->
                    <div class="flex justify-between items-center mb-6" style="flex-wrap: wrap; gap: 1rem;">
                        <h2 class="text-3xl font-bold" style="font-family: 'Noto Serif TC', serif;">
                            é£Ÿè­œåº« (${filteredRecipes.length})
                        </h2>
                        <button class="btn btn-primary" onclick="openRecipeForm()" style="background-color: ${theme.primary};">
                            â• æ–°å¢é£Ÿè­œ
                        </button>
                    </div>

                    <!-- æœå°‹ -->
                    <div class="card mb-6">
                        <div class="search-wrapper">
                            <span class="search-icon">ğŸ”</span>
                            <input type="text" class="search-input" placeholder="æœå°‹é£Ÿè­œåç¨±..." 
                                   value="${state.searchTerm}" oninput="handleSearch(this.value)">
                        </div>
                    </div>

                    <!-- é£Ÿè­œåˆ—è¡¨ -->
                    ${filteredRecipes.length === 0 ? `
                        <div class="text-center" style="padding: 5rem 0; opacity: 0.5;">
                            <p class="text-lg">å°šç„¡é£Ÿè­œï¼Œé–‹å§‹æ–°å¢æ‚¨çš„ç¬¬ä¸€å€‹é£Ÿè­œå§ï¼</p>
                        </div>
                    ` : `
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            ${filteredRecipes.map(recipe => renderRecipeCard(recipe, theme)).join('')}
                        </div>
                    `}
                </div>
            `;

            document.getElementById('recipes-view').innerHTML = html;
        }

        // æ¸²æŸ“é£Ÿè­œå¡ç‰‡
        function renderRecipeCard(recipe, theme) {
            return `
                <div class="card" style="border-left: 4px solid ${theme.primary};">
                    <div class="flex justify-between items-center" style="cursor: pointer;" onclick="toggleRecipe(${recipe.id})">
                        <div style="flex: 1;">
                            <h3 class="font-bold text-xl mb-1">${recipe.name}</h3>
                            <div class="text-sm opacity-70">
                                <div class="mb-1">
                                    ${recipe.servings || 1} äººä»½ Â· ${recipe.ingredients.length} ç¨®é£Ÿæ Â· ${recipe.steps.length} å€‹æ­¥é©Ÿ
                                </div>
                                <div class="flex items-center gap-3 flex-wrap">
                                    ${recipe.difficulty ? `<span>é›£æ˜“åº¦: ${'â­'.repeat(recipe.difficulty)}</span>` : ''}
                                    ${recipe.cookingTime ? `<span>â±ï¸ ${recipe.cookingTime} åˆ†é˜</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="event.stopPropagation(); exportRecipe(${recipe.id})" 
                                    class="btn" style="padding: 0.5rem; background: transparent;" title="åŒ¯å‡ºé£Ÿè­œ">
                                ğŸ“¥
                            </button>
                            <span id="recipe-arrow-${recipe.id}">â–¼</span>
                        </div>
                    </div>

                    <div id="recipe-content-${recipe.id}" class="collapsible-content" style="border-top: 1px solid ${theme.primary}20; margin-top: 1rem; padding-top: 1rem;">
                        <!-- é£Ÿæ -->
                        <div class="mb-6">
                            <h4 class="font-bold text-lg mb-3">ğŸ¥˜ é£Ÿæ</h4>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                ${recipe.ingredients.map(ing => `
                                    <div style="padding: 0.75rem; border-radius: 0.5rem; background-color: ${theme.background};">
                                        <div class="flex justify-between items-start">
                                            <span class="font-bold">${ing.name}</span>
                                            <span class="text-sm" style="color: ${theme.primary};">
                                                ${ing.amount} ${ing.unit === 'å…¶ä»–' && ing.customUnit ? ing.customUnit : ing.unit}
                                            </span>
                                        </div>
                                        ${ing.brand ? `<p class="text-sm opacity-70 mt-1">å“ç‰Œï¼š${ing.brand}</p>` : ''}
                                        ${ing.tips ? `<p class="text-sm mt-2" style="padding: 0.5rem; border-radius: 0.375rem; background: white;">ğŸ’¡ ${ing.tips}</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- èª¿å‘³æ–™ -->
                        <div class="mb-6">
                            <h4 class="font-bold text-lg mb-3">ğŸ§‚ èª¿å‘³æ–™</h4>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                ${recipe.seasonings.map(s => `
                                    <div style="padding: 0.75rem; border-radius: 0.5rem; background-color: ${theme.background};">
                                        <div class="flex justify-between items-start">
                                            <span class="font-bold">${s.name}</span>
                                            <span class="text-sm" style="color: ${theme.secondary};">
                                                ${s.amount} ${s.unit === 'å…¶ä»–' && s.customUnit ? s.customUnit : s.unit}
                                            </span>
                                        </div>
                                        ${s.brand ? `<p class="text-sm opacity-70 mt-1">å“ç‰Œï¼š${s.brand}</p>` : ''}
                                        ${s.tips ? `<p class="text-sm mt-2" style="padding: 0.5rem; border-radius: 0.375rem; background: white;">ğŸ’¡ ${s.tips}</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- æ­¥é©Ÿ -->
                        <div class="mb-6">
                            <h4 class="font-bold text-lg mb-3">ğŸ‘¨â€ğŸ³ æ–™ç†æ­¥é©Ÿ</h4>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                ${recipe.steps.map((step, idx) => `
                                    <div style="padding: 1rem; border-radius: 0.5rem; background-color: ${theme.background};">
                                        <div class="flex gap-3">
                                            <div class="step-number" style="background-color: ${theme.primary};">
                                                ${idx + 1}
                                            </div>
                                            <div style="flex: 1;">
                                                <p class="mb-2">${step.text}</p>
                                                ${step.tips ? `<p class="text-sm" style="padding: 0.5rem; border-radius: 0.375rem; background: white;">ğŸ’¡ ${step.tips}</p>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- æ“ä½œæŒ‰éˆ• -->
                        <div class="flex gap-3">
                            <button class="btn btn-outline flex-1" onclick="openRecipeForm(${recipe.id})" 
                                    style="border-color: ${theme.primary}; color: ${theme.primary};">
                                âœï¸ ç·¨è¼¯é£Ÿè­œ
                            </button>
                            <button class="btn btn-danger" onclick="deleteRecipe(${recipe.id})">
                                ğŸ—‘ï¸ åˆªé™¤
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // === é£Ÿè­œæ•´ç†å™¨è¦–åœ– ===
        function renderOrganizerView() {
            const theme = THEMES[state.currentSeason];

            const html = `
                <div style="margin-top: 2rem;">
                    <h2 class="text-3xl font-bold mb-6" style="font-family: 'Noto Serif TC', serif;">
                        ğŸ¤– AI é£Ÿè­œæ•´ç†å™¨
                    </h2>

                    <!-- èªªæ˜å¡ç‰‡ -->
                    <div class="card mb-6" style="background: linear-gradient(135deg, ${theme.primary}15, ${theme.secondary}15);">
                        <h3 class="font-bold text-lg mb-3">ğŸ’¡ åŠŸèƒ½èªªæ˜</h3>
                        <p class="text-sm mb-2">å°‡é›œäº‚çš„é£Ÿè­œå…§å®¹è‡ªå‹•æ•´ç†æˆæ¨™æº–åŒ–æ ¼å¼ï¼æ”¯æ´ï¼š</p>
                        <ul class="text-sm" style="list-style: disc; margin-left: 1.5rem;">
                            <li>ç¶²é é€£çµã€åœ–ç‰‡æ–‡å­—ã€æ‰‹å¯«ç­†è¨˜</li>
                            <li>è‡ªå‹•è¾¨è­˜é£Ÿæã€èª¿å‘³æ–™ã€æ­¥é©Ÿ</li>
                            <li>æ™ºæ…§åˆ†é¡ä¸¦æ¨™è¨»å–®ä½</li>
                            <li>ä¸€éµå„²å­˜åˆ°é£Ÿè­œåº«</li>
                        </ul>
                    </div>

                    <!-- è¼¸å…¥å€ -->
                    <div class="card mb-6">
                        <h3 class="font-bold text-lg mb-4">ğŸ“ è¼¸å…¥é£Ÿè­œå…§å®¹</h3>
                        
                        <!-- å¤šç¨®è¼¸å…¥æ–¹å¼ -->
                        <div class="mb-4">
                            <div class="flex gap-2 mb-3">
                                <button type="button" class="btn btn-outline text-sm" onclick="switchInputMode('text')" 
                                        id="input-mode-text"
                                        style="border-color: ${theme.primary}; color: ${theme.primary}; background: ${theme.primary}20;">
                                    ğŸ“ æ–‡å­—è¼¸å…¥
                                </button>
                                <button type="button" class="btn btn-outline text-sm" onclick="switchInputMode('url')" 
                                        id="input-mode-url"
                                        style="border-color: ${theme.primary}; color: ${theme.primary};">
                                    ğŸ”— ç¶²å€é€£çµ
                                </button>
                                <button type="button" class="btn btn-outline text-sm" onclick="switchInputMode('image')" 
                                        id="input-mode-image"
                                        style="border-color: ${theme.primary}; color: ${theme.primary};">
                                    ğŸ“· åœ–ç‰‡ä¸Šå‚³
                                </button>
                            </div>
                            
                            <!-- æ–‡å­—è¼¸å…¥æ¨¡å¼ -->
                            <div id="input-text-mode">
                                <textarea id="recipe-input" 
                                          placeholder="è«‹è²¼ä¸Šé£Ÿè­œå…§å®¹...&#10;&#10;ç¯„ä¾‹ï¼š&#10;å®®ä¿é›ä¸ï¼ˆ4äººä»½ï¼‰&#10;&#10;é£Ÿæï¼š&#10;é›èƒ¸è‚‰ 300g&#10;èŠ±ç”Ÿ 50å…‹&#10;ä¹¾è¾£æ¤’ 10æ ¹&#10;&#10;èª¿å‘³æ–™ï¼š&#10;é†¬æ²¹ 2å¤§åŒ™&#10;ç³– 1å°åŒ™&#10;é†‹ 1å¤§åŒ™&#10;&#10;æ­¥é©Ÿï¼š&#10;1. é›è‚‰åˆ‡ä¸å¾Œç”¨é†¬æ²¹å’Œå¤ªç™½ç²‰é†ƒ15åˆ†é˜&#10;2. ç†±é‹ç‚’é¦™èŠ±ç”Ÿå’Œä¹¾è¾£æ¤’&#10;3. åŠ å…¥é›è‚‰ç‚’è‡³è®Šè‰²&#10;4. åŠ å…¥èª¿å‘³æ–™æ‹Œç‚’å‡å‹»å³å¯"
                                          style="width: 100%; min-height: 300px; font-family: 'Noto Sans TC', sans-serif; padding: 1rem; border: 2px solid ${theme.primary}30; border-radius: 0.5rem;"></textarea>
                            </div>
                            
                            <!-- ç¶²å€è¼¸å…¥æ¨¡å¼ -->
                            <div id="input-url-mode" class="hidden">
                                <input type="url" id="recipe-url" 
                                       placeholder="è«‹è²¼ä¸Šé£Ÿè­œç¶²å€ï¼ˆä¾‹å¦‚ï¼šhttps://icook.tw/recipes/...ï¼‰"
                                       style="width: 100%; padding: 1rem; border: 2px solid ${theme.primary}30; border-radius: 0.5rem;">
                                <p class="text-sm opacity-70 mt-2">ğŸ’¡ æ”¯æ´ iCookã€Cookpad ç­‰é£Ÿè­œç¶²ç«™ï¼ˆå¯¦éš›æ‡‰ç”¨éœ€æ­é…å¾Œç«¯ APIï¼‰</p>
                            </div>
                            
                            <!-- åœ–ç‰‡ä¸Šå‚³æ¨¡å¼ -->
                            <div id="input-image-mode" class="hidden">
                                <div class="border-2 border-dashed rounded p-8 text-center" 
                                     style="border-color: ${theme.primary}; background: ${theme.background};">
                                    <input type="file" id="recipe-image" accept="image/*" 
                                           style="display: none;" onchange="handleImageUpload(event)">
                                    <button type="button" onclick="document.getElementById('recipe-image').click()" 
                                            class="btn btn-primary mb-2"
                                            style="background-color: ${theme.primary};">
                                        ğŸ“· é¸æ“‡åœ–ç‰‡
                                    </button>
                                    <p class="text-sm opacity-70">æ”¯æ´ JPGã€PNG æ ¼å¼</p>
                                    <p class="text-sm opacity-70 mt-1">AI æœƒè‡ªå‹•è¾¨è­˜åœ–ç‰‡ä¸­çš„æ–‡å­—</p>
                                </div>
                                <div id="image-preview" class="mt-4 hidden">
                                    <img id="preview-img" style="max-width: 100%; max-height: 300px; border-radius: 0.5rem;">
                                    <p class="text-sm mt-2">ğŸ“· å·²é¸æ“‡åœ–ç‰‡ï¼Œé»æ“Šã€Œé–‹å§‹æ•´ç†ã€é€²è¡Œ OCR è¾¨è­˜</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 mt-4">
                            <button class="btn btn-primary flex-1" onclick="organizeRecipe()" 
                                    style="background-color: ${theme.primary}; justify-content: center;">
                                ğŸ¤– é–‹å§‹æ•´ç†
                            </button>
                            <button class="btn btn-outline" onclick="clearOrganizerInput()" 
                                    style="border-color: ${theme.secondary}; color: ${theme.secondary};">
                                ğŸ—‘ï¸ æ¸…ç©º
                            </button>
                        </div>
                    </div>

                    <!-- æ•´ç†çµæœ -->
                    <div id="organized-result" class="hidden">
                        <div class="card">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-lg">âœ¨ æ•´ç†çµæœ</h3>
                                <div class="flex gap-2">
                                    <button class="btn btn-outline text-sm" onclick="editOrganizedRecipe()" 
                                            style="border-color: ${theme.primary}; color: ${theme.primary}; padding: 0.5rem 1rem;">
                                        âœï¸ ç·¨è¼¯
                                    </button>
                                    <button class="btn btn-primary text-sm" onclick="saveOrganizedRecipe()" 
                                            style="background-color: ${theme.secondary}; padding: 0.5rem 1rem;">
                                        ğŸ’¾ å„²å­˜åˆ°é£Ÿè­œåº«
                                    </button>
                                </div>
                            </div>
                            <div id="organized-preview"></div>
                        </div>
                    </div>

                    <!-- ä½¿ç”¨ç¯„ä¾‹ -->
                    <div class="card" style="background-color: ${theme.background};">
                        <h3 class="font-bold text-lg mb-3">ğŸ“š ä½¿ç”¨ç¯„ä¾‹</h3>
                        <div class="text-sm space-y-2">
                            <p><strong>ç¯„ä¾‹ 1 - ç°¡å–®æ ¼å¼ï¼š</strong></p>
                            <pre style="background: white; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.8rem;">ç•ªèŒ„ç‚’è›‹
ææ–™ï¼šç•ªèŒ„2å€‹ã€é›è›‹3å€‹ã€è”¥èŠ±é©é‡
èª¿å‘³æ–™ï¼šé¹½ã€ç³–
åšæ³•ï¼š
1. ç•ªèŒ„åˆ‡å¡Šï¼Œé›è›‹æ‰“æ•£
2. å…ˆç‚’è›‹ç››èµ·
3. ç‚’ç•ªèŒ„åŠ èª¿å‘³æ–™
4. æ”¾å›é›è›‹æ‹Œç‚’</pre>
                            
                            <p class="mt-4"><strong>ç¯„ä¾‹ 2 - ç¶²é è¤‡è£½ï¼š</strong></p>
                            <pre style="background: white; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.8rem;">ã€ç´…ç‡’ç‰›è…©ã€‘
æº–å‚™é£Ÿæï¼šç‰›è…© 500gã€ç´…è˜¿è”” 1æ ¹ã€é¦¬éˆ´è–¯ 2å€‹
èª¿å‘³æ–™ï¼šé†¬æ²¹ 3å¤§åŒ™ã€å†°ç³– 1å¤§åŒ™ã€å…«è§’ 2ç²’
æ–™ç†æ­¥é©Ÿï¼š
Step1: ç‰›è…©æ±†ç‡™å»è¡€æ°´
Step2: ç‚’é¦™é¦™æ–™
Step3: åŠ å…¥ç‰›è…©ç…¸ç‚’ä¸Šè‰²
Step4: åŠ æ°´ç‡‰ç…®1.5å°æ™‚</pre>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('organizer-view').innerHTML = html;
        }

        // æ¸²æŸ“è¨­å®šé é¢
        function renderSettingsView() {
            const theme = THEMES[state.currentSeason];

            const html = `
                <div style="margin-top: 2rem;">
                    <h2 class="text-3xl font-bold mb-6" style="font-family: 'Noto Serif TC', serif;">è¨­å®š</h2>

                    <!-- ä¸»é¡Œè¨­å®š -->
                    <div class="card mb-6">
                        <h3 class="font-bold text-xl mb-4">ä¸»é¡Œè¨­å®š</h3>
                        <div class="grid grid-4">
                            ${Object.entries(THEMES).map(([key, t]) => `
                                <button onclick="setSeason('${key}')" 
                                        class="card" 
                                        style="border: 2px solid ${state.currentSeason === key ? t.primary : '#e5e7eb'};
                                               background-color: ${state.currentSeason === key ? t.background : 'white'};
                                               text-align: center; padding: 1.5rem;
                                               transform: ${state.currentSeason === key ? 'scale(1.05)' : 'scale(1)'};
                                               cursor: pointer;">
                                    <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">${t.icon}</div>
                                    <div class="font-bold">${t.name}</div>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- ç‰ˆæœ¬è³‡è¨Š -->
                    <div class="card mb-6">
                        <h3 class="font-bold text-xl mb-4">ç‰ˆæœ¬è³‡è¨Š</h3>
                        <div style="padding: 1rem; border-radius: 0.5rem; background-color: ${theme.background}; margin-bottom: 0.5rem;">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-lg" style="color: ${theme.primary};">v1.3.1</span>
                                <span class="text-sm opacity-70">2026-02-12</span>
                            </div>
                            <p class="text-sm">æ”¹é€²åŠŸèƒ½ï¼šé£Ÿè­œç‰ˆæœ¬ç®¡ç†ã€è‡ªå‹•åŒæ­¥é£Ÿæåˆ°é£Ÿæåº«ã€å¤§å¹…æ”¹é€²AIè§£æå¼•æ“ã€æ”¯æ´ç¶²å€å’Œåœ–ç‰‡è¼¸å…¥ç•Œé¢</p>
                        </div>
                        <div style="padding: 1rem; border-radius: 0.5rem; background-color: ${theme.background}; margin-bottom: 0.5rem;">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-lg" style="color: ${theme.primary};">v1.3.0</span>
                                <span class="text-sm opacity-70">2026-02-11</span>
                            </div>
                            <p class="text-sm">æ–°å¢åŠŸèƒ½ï¼šé£Ÿè­œé›£æ˜“åº¦èˆ‡çƒ¹é£ªæ™‚é–“ã€AIé£Ÿè­œæ•´ç†å™¨ã€èª¿å‘³æ–™é è¨­å–®ä½æ”¹ç‚ºg</p>
                        </div>
                        <div style="padding: 1rem; border-radius: 0.5rem; background-color: ${theme.background}; margin-bottom: 0.5rem;">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-lg" style="color: ${theme.primary};">v1.2.0</span>
                                <span class="text-sm opacity-70">2026-02-10</span>
                            </div>
                            <p class="text-sm">æ–°å¢åŠŸèƒ½ï¼šå…¨å¹´é¸é …ã€å­£ç¯€æ™ºæ…§æ¨è–¦ã€é£Ÿæè‡ªå‹•å®Œæˆã€é€²éšå…¨æ–‡æœå°‹ã€è³‡æ–™åŒ¯å…¥/åˆ†äº«</p>
                        </div>
                        <div style="padding: 1rem; border-radius: 0.5rem; background-color: ${theme.background}; margin-bottom: 0.5rem;">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-lg" style="color: ${theme.primary};">v1.1.0</span>
                                <span class="text-sm opacity-70">2026-02-09</span>
                            </div>
                            <p class="text-sm">æ–°å¢åŠŸèƒ½ï¼šé£Ÿæå‚™è¨»åˆ†é¡ï¼ˆç‡Ÿé¤Šä¾†æºã€çƒ¹é£ªæ–¹å¼ã€æŒ‘é¸æŠ€å·§ï¼‰ã€é£Ÿè­œäººä»½èª¿æ•´ã€æ›´æ–°å–®ä½ç³»çµ±</p>
                        </div>
                        <div style="padding: 1rem; border-radius: 0.5rem; background-color: ${theme.background};">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-lg" style="color: ${theme.primary};">v1.0.0</span>
                                <span class="text-sm opacity-70">2026-02-08</span>
                            </div>
                            <p class="text-sm">åˆå§‹ç‰ˆæœ¬ç™¼å¸ƒï¼šé£Ÿæåº«ã€é£Ÿè­œåº«ã€å››å­£ä¸»é¡Œã€éŸ¿æ‡‰å¼è¨­è¨ˆ</p>
                        </div>
                    </div>

                    <!-- è³‡æ–™ç®¡ç† -->
                    <div class="card mb-6">
                        <h3 class="font-bold text-xl mb-4">è³‡æ–™ç®¡ç†</h3>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <button class="btn btn-outline" onclick="exportAllData()" 
                                    style="border-color: ${theme.primary}; color: ${theme.primary}; justify-content: center;">
                                ğŸ“¥ åŒ¯å‡ºæ‰€æœ‰è³‡æ–™
                            </button>
                            <button class="btn btn-outline" onclick="document.getElementById('import-file').click()" 
                                    style="border-color: ${theme.primary}; color: ${theme.primary}; justify-content: center;">
                                ğŸ“¤ åŒ¯å…¥è³‡æ–™
                            </button>
                            <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
                            <button class="btn btn-danger" onclick="clearAllData()" style="justify-content: center;">
                                ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™
                            </button>
                        </div>
                    </div>

                    <!-- å…±ç”¨èˆ‡åˆ†äº« -->
                    <div class="card">
                        <h3 class="font-bold text-xl mb-4">ğŸ”— å…±ç”¨èˆ‡åˆ†äº«</h3>
                        <div class="mb-4">
                            <label class="form-label">æ‚¨çš„åˆ†äº«ä»£ç¢¼</label>
                            <div class="flex gap-2">
                                <input type="text" id="share-code" readonly 
                                       value="${state.shareCode || 'å°šæœªç”Ÿæˆ'}"
                                       style="flex: 1; background: #f9f9f9;">
                                <button class="btn btn-outline" onclick="generateShareCode()" 
                                        style="border-color: ${theme.primary}; color: ${theme.primary};">
                                    ${state.shareCode ? 'é‡æ–°ç”Ÿæˆ' : 'ç”Ÿæˆä»£ç¢¼'}
                                </button>
                            </div>
                            <p class="text-sm opacity-70 mt-2">
                                å°‡æ­¤ä»£ç¢¼åˆ†äº«çµ¦å®¶äººæˆ–æœ‹å‹ï¼Œä»–å€‘å¯ä»¥ä½¿ç”¨æ­¤ä»£ç¢¼åŒ¯å…¥æ‚¨çš„é£Ÿæåº«å’Œé£Ÿè­œåº«
                            </p>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label">åŒ¯å…¥ä»–äººåˆ†äº«çš„è³‡æ–™</label>
                            <div class="flex gap-2">
                                <input type="text" id="import-share-code" 
                                       placeholder="è¼¸å…¥åˆ†äº«ä»£ç¢¼"
                                       style="flex: 1;">
                                <button class="btn btn-outline" onclick="importFromShareCode()" 
                                        style="border-color: ${theme.secondary}; color: ${theme.secondary};">
                                    åŒ¯å…¥
                                </button>
                            </div>
                        </div>

                        <div class="p-3 rounded" style="background-color: ${theme.background};">
                            <p class="text-sm">
                                <strong>ğŸ’¡ ä½¿ç”¨èªªæ˜ï¼š</strong><br>
                                1. ç”Ÿæˆæ‚¨çš„åˆ†äº«ä»£ç¢¼å¾Œï¼Œå¯è¤‡è£½çµ¦å®¶äººä½¿ç”¨<br>
                                2. ä»–äººä½¿ç”¨æ‚¨çš„ä»£ç¢¼åŒ¯å…¥å¾Œï¼Œå¯ç²å¾—ç›¸åŒçš„é£Ÿæå’Œé£Ÿè­œ<br>
                                3. åŒ¯å…¥ä¸æœƒè¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œè€Œæ˜¯åˆä½µæ–°å¢
                            </p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('settings-view').innerHTML = html;
        }

        // === äº’å‹•åŠŸèƒ½ ===

        // åˆ‡æ›æ‰‹æ©Ÿé¸å–®
        function toggleMobileMenu() {
            document.getElementById('mobileMenu').classList.toggle('open');
        }

        // æœå°‹
        function handleSearch(term) {
            state.searchTerm = term;
            renderCurrentView();
        }

        // æœˆä»½ç¯©é¸
        function setMonthFilter(month) {
            state.selectedMonth = month;
            renderCurrentView();
        }

        // åˆ†é¡ç¯©é¸
        function setCategoryFilter(category) {
            state.selectedCategory = category;
            renderCurrentView();
        }

        // åˆ‡æ›é£Ÿè­œå±•é–‹/æ”¶åˆ
        function toggleRecipe(id) {
            const content = document.getElementById(`recipe-content-${id}`);
            const arrow = document.getElementById(`recipe-arrow-${id}`);
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                arrow.textContent = 'â–¼';
            } else {
                content.classList.add('open');
                arrow.textContent = 'â–²';
            }
        }

        // === é£Ÿææ“ä½œ ===

        // é–‹å•Ÿé£Ÿæè¡¨å–®
        function openIngredientForm(id = null) {
            const ingredient = id ? state.ingredients.find(i => i.id === id) : null;
            const theme = THEMES[state.currentSeason];
            
            const formData = ingredient || {
                name: '',
                category: CATEGORIES[0],
                seasons: [],
                nutrition: '',
                cooking: '',
                selection: ''
            };

            const html = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="text-2xl font-bold" style="font-family: 'Noto Serif TC', serif;">
                                ${ingredient ? 'ç·¨è¼¯é£Ÿæ' : 'æ–°å¢é£Ÿæ'}
                            </h3>
                            <button class="close-modal" onclick="closeModal()">âœ•</button>
                        </div>
                        <div class="modal-body">
                            <form onsubmit="saveIngredient(event, ${id})" id="ingredient-form">
                                <div class="mb-4">
                                    <label class="form-label">é£Ÿæåç¨± *</label>
                                    <input type="text" name="name" value="${formData.name}" required 
                                           placeholder="ä¾‹å¦‚ï¼šç¶ èŠ±æ¤°èœ">
                                </div>

                                <div class="mb-4">
                                    <label class="form-label">åˆ†é¡ *</label>
                                    <select name="category">
                                        ${CATEGORIES.map(cat => `
                                            <option value="${cat}" ${formData.category === cat ? 'selected' : ''}>
                                                ${cat}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label">ç››ç”¢å­£ç¯€ * (å¯å¤šé¸)</label>
                                    <div class="mb-2">
                                        <button type="button" class="btn btn-outline" onclick="toggleAllSeasons()" 
                                                style="border-color: ${theme.secondary}; color: ${theme.secondary}; padding: 0.5rem 1rem;">
                                            ğŸ—“ï¸ å…¨å¹´ (1~12æœˆ)
                                        </button>
                                    </div>
                                    <div class="grid grid-4">
                                        ${MONTHS.map((month, idx) => `
                                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; cursor: pointer;">
                                                <input type="checkbox" name="seasons" value="${idx + 1}" class="season-checkbox"
                                                       ${formData.seasons.includes(idx + 1) ? 'checked' : ''}>
                                                <span>${month}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <label class="form-label">å‚™è¨»è³‡è¨Šï¼ˆé¸å¡«ï¼‰</label>
                                    
                                    <div class="mb-3">
                                        <label class="text-sm font-bold mb-1" style="display: block;">ğŸ¥— ç‡Ÿé¤Šä¾†æº</label>
                                        <textarea name="nutrition" placeholder="ä¾‹å¦‚ï¼šå¯Œå«ç¶­ç”Ÿç´ Cã€è†³é£Ÿçº–ç¶­ã€Î²-èƒ¡è˜¿è””ç´ " 
                                                  style="height: 4rem;">${formData.nutrition || ''}</textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="text-sm font-bold mb-1" style="display: block;">ğŸ‘¨â€ğŸ³ çƒ¹é£ªæ–¹å¼</label>
                                        <textarea name="cooking" placeholder="ä¾‹å¦‚ï¼šé©åˆæ¸…ç‚’ã€æ±†ç‡™ã€è’¸ç…®ï¼Œé¿å…é•·æ™‚é–“çƒ¹èª¿ä»¥ä¿ç•™ç‡Ÿé¤Š" 
                                                  style="height: 4rem;">${formData.cooking || ''}</textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="text-sm font-bold mb-1" style="display: block;">âœ¨ æŒ‘é¸æŠ€å·§</label>
                                        <textarea name="selection" placeholder="ä¾‹å¦‚ï¼šæŒ‘é¸æ™‚æ³¨æ„èŠ±çƒç·Šå¯¦ã€é¡è‰²ç¿ ç¶ ã€ç„¡é»ƒåŒ–æˆ–é»‘é»" 
                                                  style="height: 4rem;">${formData.selection || ''}</textarea>
                                    </div>
                                </div>

                                <div class="flex gap-3">
                                    <button type="button" class="btn flex-1" onclick="closeModal()" 
                                            style="border: 2px solid #ccc; background: white;">
                                        å–æ¶ˆ
                                    </button>
                                    <button type="submit" class="btn btn-primary flex-1" 
                                            style="background-color: ${theme.primary};">
                                        ğŸ’¾ å„²å­˜
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modal-container').innerHTML = html;
        }

        // å„²å­˜é£Ÿæ
        function saveIngredient(event, id) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            const seasons = Array.from(form.querySelectorAll('input[name="seasons"]:checked'))
                                 .map(cb => parseInt(cb.value));
            
            if (seasons.length === 0) {
                alert('è«‹é¸æ“‡è‡³å°‘ä¸€å€‹ç››ç”¢å­£ç¯€');
                return;
            }

            const ingredient = {
                id: id || Date.now(),
                name: formData.get('name'),
                category: formData.get('category'),
                seasons: seasons,
                nutrition: formData.get('nutrition'),
                cooking: formData.get('cooking'),
                selection: formData.get('selection')
            };

            // æª¢æŸ¥é‡è¤‡
            const existing = state.ingredients.find(i => 
                i.name.toLowerCase() === ingredient.name.toLowerCase() && i.id !== ingredient.id
            );
            
            if (existing && !confirm(`å·²å­˜åœ¨ã€Œ${ingredient.name}ã€ï¼Œç¢ºå®šè¦å»ºç«‹æ–°çš„é£Ÿæå—ï¼Ÿ`)) {
                return;
            }

            if (id) {
                state.ingredients = state.ingredients.map(i => i.id === id ? ingredient : i);
            } else {
                state.ingredients.push(ingredient);
            }

            saveData();
            closeModal();
            renderCurrentView();
        }

        // åˆªé™¤é£Ÿæ
        function deleteIngredient(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é£Ÿæå—ï¼Ÿ')) {
                state.ingredients = state.ingredients.filter(i => i.id !== id);
                saveData();
                renderCurrentView();
            }
        }

        // === é£Ÿè­œæ“ä½œ ===

        // é–‹å•Ÿé£Ÿè­œè¡¨å–®
        function openRecipeForm(id = null) {
            const recipe = id ? state.recipes.find(r => r.id === id) : null;
            const theme = THEMES[state.currentSeason];
            
            const formData = window.editingTempRecipe || recipe || {
                name: '',
                servings: 1,
                difficulty: 0,
                cookingTime: 0,
                ingredients: [{ name: '', amount: '', unit: INGREDIENT_UNITS[0], customUnit: '', brand: '', tips: '' }],
                seasonings: [{ name: '', amount: '', unit: SEASONING_UNITS[0], customUnit: '', brand: '', tips: '' }],
                steps: [{ text: '', tips: '' }]
            };
            
            // æ¸…é™¤è‡¨æ™‚ç·¨è¼¯è³‡æ–™
            window.editingTempRecipe = null;

            const html = `
                <div class="modal">
                    <div class="modal-content" style="max-width: 64rem;">
                        <div class="modal-header">
                            <h3 class="text-2xl font-bold" style="font-family: 'Noto Serif TC', serif;">
                                ${recipe ? 'ç·¨è¼¯é£Ÿè­œ' : 'æ–°å¢é£Ÿè­œ'}
                            </h3>
                            <button class="close-modal" onclick="closeModal()">âœ•</button>
                        </div>
                        <div class="modal-body">
                            <form onsubmit="saveRecipe(event, ${id})" id="recipe-form">
                                <div class="mb-4">
                                    <label class="form-label">é£Ÿè­œåç¨± *</label>
                                    <input type="text" name="name" value="${formData.name}" required 
                                           placeholder="ä¾‹å¦‚ï¼šæ»·è‚‰é£¯ã€æ»·è‚‰é£¯(åª½åª½ç‰ˆ)ã€æ»·è‚‰é£¯v2"
                                           onblur="checkRecipeNameDuplicate(this.value, ${id})">
                                    <p class="text-sm opacity-70 mt-1">ğŸ’¡ è‹¥æœ‰ç›¸åŒåç¨±ä½†ä¸åŒåšæ³•ï¼Œå»ºè­°åŠ ä¸Šç‰ˆæœ¬æ¨™è¨»ï¼Œä¾‹å¦‚ï¼šæ»·è‚‰é£¯(å®¶å¸¸ç‰ˆ)ã€æ»·è‚‰é£¯(å°å—ç‰ˆ)</p>
                                    <div id="recipe-name-warning" class="text-sm mt-2" style="display: none;"></div>
                                </div>
                                
                                <div class="mb-6">
                                    <label class="form-label">äººä»½æ•¸ *</label>
                                    <div class="flex items-center gap-3">
                                        <input type="number" name="servings" value="${formData.servings}" required min="1" max="100"
                                               style="width: 6rem;" id="servings-input" onchange="handleServingsChange(${id})">
                                        <span class="text-sm opacity-70">äººä»½</span>
                                        ${recipe ? `
                                            <button type="button" class="btn btn-outline text-sm" onclick="scaleRecipe(${recipe.servings})" 
                                                    style="border-color: ${theme.secondary}; color: ${theme.secondary}; padding: 0.5rem 1rem;">
                                                ğŸ“Š ä¾äººä»½èª¿æ•´ç”¨é‡
                                            </button>
                                        ` : ''}
                                    </div>
                                    ${recipe ? `<p class="text-sm opacity-70 mt-2">åŸå§‹äººä»½ï¼š${recipe.servings} äººä»½</p>` : ''}
                                </div>

                                <!-- é›£æ˜“åº¦èˆ‡çƒ¹é£ªæ™‚é–“ -->
                                <div class="mb-6">
                                    <div class="grid grid-2 gap-4">
                                        <div>
                                            <label class="form-label">é›£æ˜“åº¦ â­</label>
                                            <div class="flex items-center gap-2">
                                                <select name="difficulty" id="difficulty-select" style="flex: 1;">
                                                    <option value="0" ${formData.difficulty === 0 ? 'selected' : ''}>è‡ªå‹•è©•ä¼°</option>
                                                    <option value="1" ${formData.difficulty === 1 ? 'selected' : ''}>â­ éå¸¸ç°¡å–®</option>
                                                    <option value="2" ${formData.difficulty === 2 ? 'selected' : ''}>â­â­ ç°¡å–®</option>
                                                    <option value="3" ${formData.difficulty === 3 ? 'selected' : ''}>â­â­â­ ä¸­ç­‰</option>
                                                    <option value="4" ${formData.difficulty === 4 ? 'selected' : ''}>â­â­â­â­ å›°é›£</option>
                                                    <option value="5" ${formData.difficulty === 5 ? 'selected' : ''}>â­â­â­â­â­ éå¸¸å›°é›£</option>
                                                </select>
                                                ${!recipe ? `
                                                    <button type="button" class="btn btn-outline text-sm" onclick="autoCalculateDifficulty()" 
                                                            style="border-color: ${theme.secondary}; color: ${theme.secondary}; padding: 0.5rem 1rem; white-space: nowrap;">
                                                        ğŸ¤– è‡ªå‹•è©•ä¼°
                                                    </button>
                                                ` : ''}
                                            </div>
                                            <p class="text-sm opacity-70 mt-1">æ ¹æ“šé£Ÿææ•¸é‡å’Œæ­¥é©Ÿè¤‡é›œåº¦è‡ªå‹•è©•ä¼°</p>
                                        </div>
                                        
                                        <div>
                                            <label class="form-label">é ä¼°çƒ¹é£ªæ™‚é–“ï¼ˆåˆ†é˜ï¼‰â±ï¸</label>
                                            <input type="number" name="cookingTime" value="${formData.cookingTime || ''}" min="0" max="999"
                                                   placeholder="å«å‚™æ–™èˆ‡çƒ¹èª¿æ™‚é–“" style="width: 100%;">
                                            <p class="text-sm opacity-70 mt-1">åŒ…å«å‚™æ–™ã€çƒ¹èª¿ã€ç‡‰ç…®ç­‰ç¸½æ™‚é–“</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- é£Ÿæå€ -->
                                <div class="mb-6">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="font-bold text-lg">ğŸ¥˜ é£Ÿæ</h4>
                                        <button type="button" class="btn btn-primary" onclick="addFormItem('ingredients')" 
                                                style="background-color: ${theme.primary}; padding: 0.5rem 1rem;">
                                            â• æ–°å¢
                                        </button>
                                    </div>
                                    <div id="ingredients-container">
                                        ${formData.ingredients.map((ing, idx) => renderIngredientFormItem(ing, idx, theme)).join('')}
                                    </div>
                                </div>

                                <!-- èª¿å‘³æ–™å€ -->
                                <div class="mb-6">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="font-bold text-lg">ğŸ§‚ èª¿å‘³æ–™</h4>
                                        <button type="button" class="btn" onclick="addFormItem('seasonings')" 
                                                style="background-color: ${theme.secondary}; color: white; padding: 0.5rem 1rem;">
                                            â• æ–°å¢
                                        </button>
                                    </div>
                                    <div id="seasonings-container">
                                        ${formData.seasonings.map((s, idx) => renderSeasoningFormItem(s, idx, theme)).join('')}
                                    </div>
                                </div>

                                <!-- æ­¥é©Ÿå€ -->
                                <div class="mb-6">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="font-bold text-lg">ğŸ‘¨â€ğŸ³ æ–™ç†æ­¥é©Ÿ</h4>
                                        <button type="button" class="btn btn-primary" onclick="addFormItem('steps')" 
                                                style="background-color: ${theme.primary}; padding: 0.5rem 1rem;">
                                            â• æ–°å¢
                                        </button>
                                    </div>
                                    <div id="steps-container">
                                        ${formData.steps.map((step, idx) => renderStepFormItem(step, idx, theme)).join('')}
                                    </div>
                                </div>

                                <div class="flex gap-3">
                                    <button type="button" class="btn flex-1" onclick="closeModal()" 
                                            style="border: 2px solid #ccc; background: white;">
                                        å–æ¶ˆ
                                    </button>
                                    <button type="submit" class="btn btn-primary flex-1" 
                                            style="background-color: ${theme.primary};">
                                        ğŸ’¾ å„²å­˜é£Ÿè­œ
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modal-container').innerHTML = html;
        }

        // æ¸²æŸ“é£Ÿæè¡¨å–®é …ç›®
        function renderIngredientFormItem(item, idx, theme) {
            const showCustomUnit = item.unit === 'å…¶ä»–' || (item.customUnit && !INGREDIENT_UNITS.includes(item.unit));
            
            return `
                <div class="form-item" style="border-color: ${theme.primary}40;">
                    <div class="grid grid-4 gap-2 mb-2">
                        <div style="position: relative;">
                            <input type="text" placeholder="å“å *" value="${item.name}" 
                                   data-type="ingredients" data-idx="${idx}" data-field="name"
                                   id="ingredient-name-${idx}"
                                   onfocus="setupAutocomplete(this, 'ingredients')">
                        </div>
                        <input type="text" placeholder="ç”¨é‡ *" value="${item.amount}" 
                               data-type="ingredients" data-idx="${idx}" data-field="amount"
                               class="ingredient-amount">
                        <select data-type="ingredients" data-idx="${idx}" data-field="unit" 
                                onchange="toggleCustomUnit('ingredients', ${idx}, this.value)">
                            ${INGREDIENT_UNITS.map(unit => `<option value="${unit}" ${item.unit === unit ? 'selected' : ''}>${unit}</option>`).join('')}
                        </select>
                        <input type="text" placeholder="å“ç¨®/å“ç‰Œ" value="${item.brand || ''}" 
                               data-type="ingredients" data-idx="${idx}" data-field="brand">
                    </div>
                    ${showCustomUnit || item.unit === 'å…¶ä»–' ? `
                        <div class="mb-2">
                            <input type="text" placeholder="è«‹è¼¸å…¥è‡ªå®šç¾©å–®ä½" value="${item.customUnit || ''}" 
                                   data-type="ingredients" data-idx="${idx}" data-field="customUnit"
                                   id="custom-unit-ingredients-${idx}">
                        </div>
                    ` : ''}
                    <div class="flex gap-2">
                        <input type="text" placeholder="æç¤º/Tips" value="${item.tips || ''}" style="flex: 1;"
                               data-type="ingredients" data-idx="${idx}" data-field="tips">
                        <button type="button" class="btn btn-danger" onclick="removeFormItem('ingredients', ${idx})">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“èª¿å‘³æ–™è¡¨å–®é …ç›®
        function renderSeasoningFormItem(item, idx, theme) {
            const showCustomUnit = item.unit === 'å…¶ä»–' || (item.customUnit && !SEASONING_UNITS.includes(item.unit));
            
            return `
                <div class="form-item" style="border-color: ${theme.secondary}40;">
                    <div class="grid grid-4 gap-2 mb-2">
                        <div style="position: relative;">
                            <input type="text" placeholder="å“å *" value="${item.name}" 
                                   data-type="seasonings" data-idx="${idx}" data-field="name"
                                   id="seasoning-name-${idx}"
                                   onfocus="setupAutocomplete(this, 'seasonings')">
                        </div>
                        <input type="text" placeholder="ç”¨é‡ *" value="${item.amount}" 
                               data-type="seasonings" data-idx="${idx}" data-field="amount"
                               class="seasoning-amount">
                        <select data-type="seasonings" data-idx="${idx}" data-field="unit"
                                onchange="toggleCustomUnit('seasonings', ${idx}, this.value)">
                            ${SEASONING_UNITS.map(unit => `<option value="${unit}" ${item.unit === unit ? 'selected' : ''}>${unit}</option>`).join('')}
                        </select>
                        <input type="text" placeholder="å“ç¨®/å“ç‰Œ" value="${item.brand || ''}" 
                               data-type="seasonings" data-idx="${idx}" data-field="brand">
                    </div>
                    ${showCustomUnit || item.unit === 'å…¶ä»–' ? `
                        <div class="mb-2">
                            <input type="text" placeholder="è«‹è¼¸å…¥è‡ªå®šç¾©å–®ä½" value="${item.customUnit || ''}" 
                                   data-type="seasonings" data-idx="${idx}" data-field="customUnit"
                                   id="custom-unit-seasonings-${idx}">
                        </div>
                    ` : ''}
                    <div class="flex gap-2">
                        <input type="text" placeholder="æç¤º/Tips" value="${item.tips || ''}" style="flex: 1;"
                               data-type="seasonings" data-idx="${idx}" data-field="tips">
                        <button type="button" class="btn btn-danger" onclick="removeFormItem('seasonings', ${idx})">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“æ­¥é©Ÿè¡¨å–®é …ç›®
        function renderStepFormItem(item, idx, theme) {
            return `
                <div class="form-item" style="border-color: ${theme.primary}40;">
                    <div class="flex gap-3 mb-2">
                        <div class="step-number" style="background-color: ${theme.primary};">
                            ${idx + 1}
                        </div>
                        <textarea placeholder="æ­¥é©Ÿèªªæ˜ *" style="flex: 1; height: 6rem;" 
                                  data-type="steps" data-idx="${idx}" data-field="text">${item.text}</textarea>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" placeholder="æç¤º/Tips" value="${item.tips}" style="flex: 1;"
                               data-type="steps" data-idx="${idx}" data-field="tips">
                        <button type="button" class="btn btn-danger" onclick="removeFormItem('steps', ${idx})">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `;
        }

        // åˆ‡æ›å…¨å¹´é¸é …
        function toggleAllSeasons() {
            const checkboxes = document.querySelectorAll('.season-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
        }

        // è‡ªå‹•å®ŒæˆåŠŸèƒ½
        function setupAutocomplete(inputElement, type) {
            let autocompleteList = null;
            
            inputElement.addEventListener('input', function(e) {
                const value = this.value.toLowerCase();
                closeAllLists();
                
                if (!value) return;
                
                // å¾é£Ÿæåº«ç²å–åŒ¹é…çš„é£Ÿæ
                const matches = state.ingredients
                    .filter(ing => ing.name.toLowerCase().includes(value))
                    .slice(0, 5);
                
                if (matches.length === 0) return;
                
                // å‰µå»ºè‡ªå‹•å®Œæˆåˆ—è¡¨
                autocompleteList = document.createElement('div');
                autocompleteList.setAttribute('class', 'autocomplete-items');
                autocompleteList.style.cssText = `
                    position: absolute;
                    border: 1px solid #d4d4d4;
                    border-top: none;
                    z-index: 99;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: white;
                    max-height: 200px;
                    overflow-y: auto;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                    border-radius: 0 0 0.5rem 0.5rem;
                `;
                
                matches.forEach(ing => {
                    const item = document.createElement('div');
                    item.style.cssText = `
                        padding: 0.75rem;
                        cursor: pointer;
                        border-bottom: 1px solid #f0f0f0;
                    `;
                    item.innerHTML = `
                        <div style="font-weight: 500;">${ing.name}</div>
                        <div style="font-size: 0.75rem; opacity: 0.7;">${ing.category}</div>
                    `;
                    
                    item.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#f3f4f6';
                    });
                    item.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = 'white';
                    });
                    
                    item.addEventListener('click', function() {
                        inputElement.value = ing.name;
                        closeAllLists();
                    });
                    
                    autocompleteList.appendChild(item);
                });
                
                inputElement.parentNode.style.position = 'relative';
                inputElement.parentNode.appendChild(autocompleteList);
            });
            
            function closeAllLists() {
                const items = document.getElementsByClassName('autocomplete-items');
                Array.from(items).forEach(item => item.remove());
            }
            
            document.addEventListener('click', function(e) {
                if (e.target !== inputElement) {
                    closeAllLists();
                }
            });
        }

        // åˆ‡æ›è‡ªå®šç¾©å–®ä½è¼¸å…¥æ¡†
        function toggleCustomUnit(type, idx, value) {
            const container = document.getElementById(`${type}-container`);
            const item = container.children[idx];
            const existingCustomInput = item.querySelector(`#custom-unit-${type}-${idx}`);
            
            if (value === 'å…¶ä»–') {
                if (!existingCustomInput) {
                    const grid = item.querySelector('.grid');
                    const customUnitHtml = `
                        <div class="mb-2" style="grid-column: 1 / -1;">
                            <input type="text" placeholder="è«‹è¼¸å…¥è‡ªå®šç¾©å–®ä½" 
                                   data-type="${type}" data-idx="${idx}" data-field="customUnit"
                                   id="custom-unit-${type}-${idx}">
                        </div>
                    `;
                    grid.insertAdjacentHTML('afterend', customUnitHtml);
                }
            } else {
                if (existingCustomInput && existingCustomInput.parentElement) {
                    existingCustomInput.parentElement.remove();
                }
            }
        }

        // äººä»½èª¿æ•´
        function scaleRecipe(originalServings) {
            const newServings = parseFloat(document.getElementById('servings-input').value);
            if (!newServings || newServings <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„äººä»½æ•¸');
                return;
            }
            
            const scale = newServings / originalServings;
            
            if (!confirm(`ç¢ºå®šè¦å°‡æ‰€æœ‰ç”¨é‡å¾ ${originalServings} äººä»½èª¿æ•´ç‚º ${newServings} äººä»½å—ï¼Ÿ\nå€æ•¸ï¼š${scale.toFixed(2)}x`)) {
                return;
            }
            
            // èª¿æ•´é£Ÿæç”¨é‡
            document.querySelectorAll('.ingredient-amount').forEach(input => {
                const currentAmount = parseFloat(input.value);
                if (!isNaN(currentAmount)) {
                    input.value = (currentAmount * scale).toFixed(2);
                }
            });
            
            // èª¿æ•´èª¿å‘³æ–™ç”¨é‡
            document.querySelectorAll('.seasoning-amount').forEach(input => {
                const currentAmount = parseFloat(input.value);
                if (!isNaN(currentAmount)) {
                    input.value = (currentAmount * scale).toFixed(2);
                }
            });
            
            alert('ç”¨é‡å·²èª¿æ•´å®Œæˆï¼');
        }

        // æ–°å¢è¡¨å–®é …ç›®
        function addFormItem(type) {
            const theme = THEMES[state.currentSeason];
            const container = document.getElementById(`${type}-container`);
            const currentCount = container.children.length;
            
            let html = '';
            if (type === 'ingredients') {
                html = renderIngredientFormItem({ name: '', amount: '', unit: INGREDIENT_UNITS[0], customUnit: '', brand: '', tips: '' }, currentCount, theme);
            } else if (type === 'seasonings') {
                html = renderSeasoningFormItem({ name: '', amount: '', unit: SEASONING_UNITS[0], customUnit: '', brand: '', tips: '' }, currentCount, theme);
            } else if (type === 'steps') {
                html = renderStepFormItem({ text: '', tips: '' }, currentCount, theme);
            }
            
            container.insertAdjacentHTML('beforeend', html);
        }

        // ç§»é™¤è¡¨å–®é …ç›®
        function removeFormItem(type, idx) {
            const container = document.getElementById(`${type}-container`);
            const items = container.children;
            if (items.length > 1) {
                items[idx].remove();
                // é‡æ–°ç·¨è™Ÿæ­¥é©Ÿ
                if (type === 'steps') {
                    Array.from(container.children).forEach((item, newIdx) => {
                        const number = item.querySelector('.step-number');
                        if (number) number.textContent = newIdx + 1;
                        // æ›´æ–° data-idx
                        item.querySelectorAll('[data-idx]').forEach(el => {
                            el.setAttribute('data-idx', newIdx);
                        });
                    });
                }
            }
        }

        // å„²å­˜é£Ÿè­œ
        function saveRecipe(event, id) {
            event.preventDefault();
            
            const form = event.target;
            
            // æ”¶é›†é£Ÿæ
            const ingredients = [];
            document.querySelectorAll('[data-type="ingredients"]').forEach(el => {
                const idx = parseInt(el.dataset.idx);
                const field = el.dataset.field;
                if (!ingredients[idx]) ingredients[idx] = {};
                ingredients[idx][field] = el.value;
            });
            
            // æ”¶é›†èª¿å‘³æ–™
            const seasonings = [];
            document.querySelectorAll('[data-type="seasonings"]').forEach(el => {
                const idx = parseInt(el.dataset.idx);
                const field = el.dataset.field;
                if (!seasonings[idx]) seasonings[idx] = {};
                seasonings[idx][field] = el.value;
            });
            
            // æ”¶é›†æ­¥é©Ÿ
            const steps = [];
            document.querySelectorAll('[data-type="steps"]').forEach(el => {
                const idx = parseInt(el.dataset.idx);
                const field = el.dataset.field;
                if (!steps[idx]) steps[idx] = {};
                steps[idx][field] = el.value;
            });

            // é©—è­‰
            const validIngredients = ingredients.filter(i => i.name && i.amount && i.unit);
            if (validIngredients.length === 0) {
                alert('è«‹è‡³å°‘æ–°å¢ä¸€é …é£Ÿæï¼ˆå“åã€ç”¨é‡ã€å–®ä½ç‚ºå¿…å¡«ï¼‰');
                return;
            }

            const validSteps = steps.filter(s => s.text && s.text.trim());
            if (validSteps.length === 0) {
                alert('è«‹è‡³å°‘æ–°å¢ä¸€å€‹æ–™ç†æ­¥é©Ÿ');
                return;
            }

            const recipe = {
                id: id || Date.now(),
                name: form.name.value,
                servings: parseInt(form.servings.value) || 1,
                difficulty: parseInt(form.difficulty.value) || 0,
                cookingTime: parseInt(form.cookingTime.value) || 0,
                ingredients: validIngredients,
                seasonings: seasonings.filter(s => s.name && s.amount && s.unit),
                steps: validSteps
            };

            if (id) {
                state.recipes = state.recipes.map(r => r.id === id ? recipe : r);
            } else {
                state.recipes.push(recipe);
            }

            // è‡ªå‹•åŒæ­¥æ–°é£Ÿæåˆ°é£Ÿæåº«
            syncIngredientsToLibrary(recipe);

            saveData();
            closeModal();
            renderCurrentView();
        }

        // æª¢æŸ¥é£Ÿè­œåç¨±é‡è¤‡
        function checkRecipeNameDuplicate(name, currentId) {
            if (!name || !name.trim()) return;
            
            const theme = THEMES[state.currentSeason];
            const duplicates = state.recipes.filter(r => 
                r.name.toLowerCase() === name.toLowerCase().trim() && 
                (!currentId || r.id !== currentId)
            );
            
            const warningDiv = document.getElementById('recipe-name-warning');
            if (!warningDiv) return;
            
            if (duplicates.length > 0) {
                warningDiv.style.display = 'block';
                warningDiv.style.color = theme.secondary;
                warningDiv.style.backgroundColor = theme.secondary + '20';
                warningDiv.style.padding = '0.5rem';
                warningDiv.style.borderRadius = '0.375rem';
                warningDiv.innerHTML = `
                    âš ï¸ å·²æœ‰ ${duplicates.length} å€‹åŒåé£Ÿè­œã€Œ${name}ã€<br>
                    ğŸ’¡ å»ºè­°åŠ ä¸Šç‰ˆæœ¬æ¨™è¨»ä»¥å€åˆ†ï¼Œä¾‹å¦‚ï¼š${name}(å®¶å¸¸ç‰ˆ)ã€${name}(ç°¡æ˜“ç‰ˆ)
                `;
            } else {
                warningDiv.style.display = 'none';
            }
        }

        // åŒæ­¥é£Ÿæåˆ°é£Ÿæåº«
        function syncIngredientsToLibrary(recipe) {
            const newIngredients = [];
            
            // åˆä½µé£Ÿæå’Œèª¿å‘³æ–™
            const allItems = [
                ...recipe.ingredients.map(i => ({ ...i, source: 'ingredient' })),
                ...recipe.seasonings.map(s => ({ ...s, source: 'seasoning' }))
            ];
            
            allItems.forEach(item => {
                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ–¼é£Ÿæåº«
                const exists = state.ingredients.find(ing => 
                    ing.name.toLowerCase() === item.name.toLowerCase()
                );
                
                if (!exists && item.name.trim()) {
                    newIngredients.push(item);
                }
            });
            
            if (newIngredients.length > 0) {
                // é¡¯ç¤ºåŒæ­¥å°è©±æ¡†
                showIngredientSyncDialog(newIngredients);
            }
        }

        // é¡¯ç¤ºé£ŸæåŒæ­¥å°è©±æ¡†
        function showIngredientSyncDialog(items) {
            const theme = THEMES[state.currentSeason];
            
            const html = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="text-2xl font-bold" style="font-family: 'Noto Serif TC', serif;">
                                ğŸ”„ åŒæ­¥æ–°é£Ÿæåˆ°é£Ÿæåº«
                            </h3>
                            <button class="close-modal" onclick="closeIngredientSyncDialog(false)">âœ•</button>
                        </div>
                        <div class="modal-body">
                            <p class="mb-4">ç™¼ç¾ <strong>${items.length}</strong> å€‹æ–°é£Ÿæï¼Œæ˜¯å¦è¦åŒæ­¥åˆ°é£Ÿæåº«ï¼Ÿ</p>
                            <p class="text-sm opacity-70 mb-4">åŒæ­¥å¾Œå¯åœ¨é£Ÿæåº«ä¸­å®Œå–„ç‡Ÿé¤Šã€çƒ¹é£ªæ–¹å¼ã€æŒ‘é¸æŠ€å·§ç­‰è³‡è¨Šã€‚</p>
                            
                            <div style="max-height: 400px; overflow-y: auto; margin-bottom: 1rem;">
                                ${items.map((item, idx) => `
                                    <div class="mb-4 p-4 rounded" style="background-color: ${theme.background}; border-left: 3px solid ${theme.primary};">
                                        <div class="flex items-start gap-3">
                                            <input type="checkbox" id="sync-item-${idx}" checked 
                                                   style="margin-top: 0.25rem; width: 1.25rem; height: 1.25rem;">
                                            <div style="flex: 1;">
                                                <div class="font-bold mb-2">${item.name}</div>
                                                
                                                <div class="mb-2">
                                                    <label class="text-sm font-medium">åˆ†é¡ *</label>
                                                    <select id="sync-category-${idx}" class="w-full mt-1 p-2 border rounded">
                                                        ${CATEGORIES.map(cat => `
                                                            <option value="${cat}" ${guessCategoryByName(item.name, item.source) === cat ? 'selected' : ''}>
                                                                ${cat}
                                                            </option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                
                                                <div>
                                                    <label class="text-sm font-medium">ç››ç”¢å­£ç¯€ï¼ˆå¯é¸æ“‡å¤šå€‹æœˆä»½ï¼Œæˆ–é¸å…¨å¹´ï¼‰</label>
                                                    <div class="mt-1">
                                                        <button type="button" class="text-sm px-2 py-1 rounded border" 
                                                                onclick="toggleAllSeasonsInSync(${idx})"
                                                                style="border-color: ${theme.secondary}; color: ${theme.secondary};">
                                                            å…¨å¹´
                                                        </button>
                                                    </div>
                                                    <div class="grid grid-4 gap-1 mt-2">
                                                        ${MONTHS.map((month, mIdx) => `
                                                            <label class="text-xs flex items-center gap-1">
                                                                <input type="checkbox" class="sync-season-${idx}" value="${mIdx + 1}">
                                                                ${month}
                                                            </label>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="flex gap-3">
                                <button class="btn flex-1" onclick="closeIngredientSyncDialog(false)" 
                                        style="border: 2px solid #ccc; background: white;">
                                    è·³é
                                </button>
                                <button class="btn btn-primary flex-1" onclick="confirmIngredientSync(${JSON.stringify(items).replace(/"/g, '&quot;')})" 
                                        style="background-color: ${theme.primary};">
                                    ğŸ’¾ åŒæ­¥åˆ°é£Ÿæåº«
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // å‰µå»ºè‡¨æ™‚å®¹å™¨
            const syncContainer = document.createElement('div');
            syncContainer.id = 'sync-modal-container';
            syncContainer.innerHTML = html;
            document.body.appendChild(syncContainer);
        }

        // æ ¹æ“šé£Ÿæåç¨±çŒœæ¸¬åˆ†é¡
        function guessCategoryByName(name, source) {
            const nameLower = name.toLowerCase();
            
            // ç¦½è‚‰é¡
            if (nameLower.match(/é›|é´¨|éµ|ç«é›|é›è‚‰|é›èƒ¸|é›è…¿|é›ç¿…/)) return 'ç¦½è‚‰é¡';
            if (nameLower.match(/è±¬|ç‰›|ç¾Š|è‚‰|çµè‚‰|è‚‰ç‰‡|è‚‰çµ²|æ’éª¨|äº”èŠ±|è…±|é‡Œè‚Œ/)) return 'ç¦½è‚‰é¡';
            
            // æµ·é®®é¡
            if (nameLower.match(/é­š|è¦|èŸ¹|è²|è›¤|èšµ|é­·|èŠ±æ|ç« é­š|é®­|é±ˆ|é¯›|é°»/)) return 'æµ·é®®é¡';
            
            // è›‹è±†é¡
            if (nameLower.match(/è›‹|è±†è…|è±†|è±†å¹²|è±†çš®|è±†æ¼¿|è±†èŠ½/)) return 'è›‹è±†é¡';
            
            // è”¬èœé¡
            if (nameLower.match(/èœ|è”¬|é’|ç™½èœ|é«˜éº—|èŠ±æ¤°|è èœ|èµ|èŠ¹|éŸ­|è”¥|è’œ|è–‘|ç­|ç“œ|èŒ„|æ¤’|ç•ªèŒ„|è˜¿è””|é¦¬éˆ´è–¯/)) return 'è”¬èœé¡';
            
            // æ°´æœé¡
            if (nameLower.match(/æœ|è˜‹|æ©˜|æŸ³|èŠ’|é¦™è•‰|è‘¡è„|è¥¿ç“œ|æª¸æª¬|æŸš|æ¢¨|æ¡ƒ|è“/)) return 'æ°´æœé¡';
            
            // é£²å“é¡
            if (nameLower.match(/æ°´|æ±|èŒ¶|é…’|å¥¶|ä¹³|å’–å•¡|å¯æ¨‚|æ±½æ°´/)) return 'é£²å“é¡';
            
            // æ¾±ç²‰ä¸»é£Ÿé¡
            if (nameLower.match(/é£¯|éºµ|ç²‰|ç±³|éºµåŒ…|é¥…é ­|åŒ…å­|é¤ƒ|é¤…|ç²¥|pasta|éºµæ¢|å†¬ç²‰|ç±³ç²‰|æ²³ç²‰/)) return 'æ¾±ç²‰ä¸»é£Ÿé¡';
            
            // é¦™æ–™èª¿å‘³å“é¡ï¼ˆå„ªå…ˆåˆ¤æ–·ä¾†æºï¼‰
            if (source === 'seasoning') return 'é¦™æ–™èª¿å‘³å“é¡';
            if (nameLower.match(/é†¬|æ²¹|é¹½|ç³–|é†‹|é…’|ç²‰|æ–™|é¦™|æ¤’|è¾£|å‘³|èƒ¡æ¤’|å…«è§’|æ¡‚|è”¥|è’œ|è–‘/)) return 'é¦™æ–™èª¿å‘³å“é¡';
            
            // é è¨­
            return 'è”¬èœé¡';
        }

        // åˆ‡æ›åŒæ­¥å°è©±æ¡†ä¸­çš„å…¨å¹´é¸é …
        function toggleAllSeasonsInSync(idx) {
            const checkboxes = document.querySelectorAll(`.sync-season-${idx}`);
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
        }

        // ç¢ºèªåŒæ­¥é£Ÿæ
        function confirmIngredientSync(items) {
            let syncCount = 0;
            
            items.forEach((item, idx) => {
                const checkbox = document.getElementById(`sync-item-${idx}`);
                if (!checkbox.checked) return;
                
                const category = document.getElementById(`sync-category-${idx}`).value;
                const seasonCheckboxes = document.querySelectorAll(`.sync-season-${idx}:checked`);
                const seasons = Array.from(seasonCheckboxes).map(cb => parseInt(cb.value));
                
                if (seasons.length === 0) {
                    alert(`${item.name} æœªé¸æ“‡ç››ç”¢å­£ç¯€ï¼`);
                    return;
                }
                
                const newIngredient = {
                    id: Date.now() + idx,
                    name: item.name,
                    category: category,
                    seasons: seasons,
                    nutrition: '',
                    cooking: '',
                    selection: ''
                };
                
                state.ingredients.push(newIngredient);
                syncCount++;
            });
            
            saveData();
            closeIngredientSyncDialog(true);
            
            if (syncCount > 0) {
                alert(`æˆåŠŸåŒæ­¥ ${syncCount} å€‹é£Ÿæåˆ°é£Ÿæåº«ï¼\næ‚¨å¯ä»¥ç¨å¾Œåˆ°é£Ÿæåº«å®Œå–„é€™äº›é£Ÿæçš„è©³ç´°è³‡è¨Šã€‚`);
            }
        }

        // é—œé–‰åŒæ­¥å°è©±æ¡†
        function closeIngredientSyncDialog(synced) {
            const container = document.getElementById('sync-modal-container');
            if (container) {
                container.remove();
            }
        }

        // åˆªé™¤é£Ÿè­œ
        function deleteRecipe(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é£Ÿè­œå—ï¼Ÿ')) {
                state.recipes = state.recipes.filter(r => r.id !== id);
                saveData();
                renderCurrentView();
            }
        }

        // åŒ¯å‡ºé£Ÿè­œ
        function exportRecipe(id) {
            const recipe = state.recipes.find(r => r.id === id);
            if (!recipe) return;

            let markdown = `# ${recipe.name}\n\n`;
            markdown += `**äººä»½æ•¸ï¼š** ${recipe.servings || 1} äººä»½\n\n`;
            
            markdown += `## é£Ÿæ\n`;
            recipe.ingredients.forEach(ing => {
                const unit = ing.unit === 'å…¶ä»–' && ing.customUnit ? ing.customUnit : ing.unit;
                markdown += `- ${ing.name} ${ing.amount} ${unit}`;
                if (ing.brand) markdown += ` (${ing.brand})`;
                if (ing.tips) markdown += ` - ${ing.tips}`;
                markdown += '\n';
            });
            
            markdown += `\n## èª¿å‘³æ–™\n`;
            recipe.seasonings.forEach(s => {
                const unit = s.unit === 'å…¶ä»–' && s.customUnit ? s.customUnit : s.unit;
                markdown += `- ${s.name} ${s.amount} ${unit}`;
                if (s.brand) markdown += ` (${s.brand})`;
                if (s.tips) markdown += ` - ${s.tips}`;
                markdown += '\n';
            });
            
            markdown += `\n## æ­¥é©Ÿ\n`;
            recipe.steps.forEach((step, idx) => {
                markdown += `${idx + 1}. ${step.text}`;
                if (step.tips) markdown += ` (ğŸ’¡ ${step.tips})`;
                markdown += '\n';
            });

            navigator.clipboard.writeText(markdown).then(() => {
                alert('é£Ÿè­œå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            });
        }

        // === é€šç”¨åŠŸèƒ½ ===

        // é—œé–‰ Modal
        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        // åŒ¯å‡ºæ‰€æœ‰è³‡æ–™
        function exportAllData() {
            const data = {
                ingredients: state.ingredients,
                recipes: state.recipes
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `foodie-graph-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ¸…ç©ºæ‰€æœ‰è³‡æ–™
        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                state.ingredients = [];
                state.recipes = [];
                saveData();
                renderCurrentView();
            }
        }

        // åŒ¯å…¥è³‡æ–™
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.ingredients && !data.recipes) {
                        alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼è«‹é¸æ“‡æ­£ç¢ºçš„åŒ¯å‡ºæª”æ¡ˆã€‚');
                        return;
                    }

                    const mode = confirm('é»é¸ã€Œç¢ºå®šã€åˆä½µè³‡æ–™ï¼ˆä¿ç•™ç¾æœ‰è³‡æ–™ï¼‰\né»é¸ã€Œå–æ¶ˆã€è¦†è“‹è³‡æ–™ï¼ˆæ¸…ç©ºç¾æœ‰è³‡æ–™ï¼‰');
                    
                    if (mode) {
                        // åˆä½µæ¨¡å¼
                        if (data.ingredients) {
                            data.ingredients.forEach(ing => {
                                if (!state.ingredients.find(i => i.id === ing.id)) {
                                    state.ingredients.push(ing);
                                }
                            });
                        }
                        if (data.recipes) {
                            data.recipes.forEach(recipe => {
                                if (!state.recipes.find(r => r.id === recipe.id)) {
                                    state.recipes.push(recipe);
                                }
                            });
                        }
                    } else {
                        // è¦†è“‹æ¨¡å¼
                        if (data.ingredients) state.ingredients = data.ingredients;
                        if (data.recipes) state.recipes = data.recipes;
                    }

                    saveData();
                    renderCurrentView();
                    alert('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
                } catch (error) {
                    alert('æª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // æ¸…ç©º inputï¼Œå…è¨±é‡è¤‡é¸æ“‡åŒä¸€æª”æ¡ˆ
        }

        // ç”Ÿæˆåˆ†äº«ä»£ç¢¼
        function generateShareCode() {
            const data = {
                ingredients: state.ingredients,
                recipes: state.recipes,
                timestamp: Date.now()
            };
            
            // å°‡è³‡æ–™è½‰æ›ç‚º Base64
            const jsonString = JSON.stringify(data);
            const base64 = btoa(unescape(encodeURIComponent(jsonString)));
            
            // ç”Ÿæˆç°¡çŸ­ä»£ç¢¼ï¼ˆå–å‰12ä½ä½œç‚ºä»£ç¢¼ï¼‰
            const shortCode = base64.substring(0, 12).toUpperCase();
            
            // å„²å­˜å®Œæ•´è³‡æ–™åˆ° localStorageï¼ˆä½¿ç”¨ä»£ç¢¼ä½œç‚ºéµï¼‰
            localStorage.setItem(`foodie-share-${shortCode}`, base64);
            
            state.shareCode = shortCode;
            localStorage.setItem('foodie-share-code', shortCode);
            
            renderCurrentView();
            
            // è¤‡è£½åˆ°å‰ªè²¼ç°¿
            navigator.clipboard.writeText(shortCode).then(() => {
                alert(`åˆ†äº«ä»£ç¢¼å·²ç”Ÿæˆä¸¦è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼š${shortCode}\n\nè«‹å°‡æ­¤ä»£ç¢¼åˆ†äº«çµ¦æ‚¨çš„å®¶äººæˆ–æœ‹å‹ï¼`);
            });
        }

        // å¾åˆ†äº«ä»£ç¢¼åŒ¯å…¥
        function importFromShareCode() {
            const code = document.getElementById('import-share-code').value.trim().toUpperCase();
            
            if (!code) {
                alert('è«‹è¼¸å…¥åˆ†äº«ä»£ç¢¼ï¼');
                return;
            }

            // å¾ localStorage ç²å–è³‡æ–™
            const base64Data = localStorage.getItem(`foodie-share-${code}`);
            
            if (!base64Data) {
                alert('ç„¡æ•ˆçš„åˆ†äº«ä»£ç¢¼æˆ–è³‡æ–™å·²éæœŸï¼\n\næ³¨æ„ï¼šåˆ†äº«ä»£ç¢¼åƒ…åœ¨ç”Ÿæˆè€…çš„ç€è¦½å™¨ä¸­æœ‰æ•ˆã€‚\nè‹¥è¦è·¨è£ç½®åˆ†äº«ï¼Œè«‹ä½¿ç”¨ã€ŒåŒ¯å‡º/åŒ¯å…¥è³‡æ–™ã€åŠŸèƒ½ã€‚');
                return;
            }

            try {
                const jsonString = decodeURIComponent(escape(atob(base64Data)));
                const data = JSON.parse(jsonString);
                
                const mode = confirm(`æ‰¾åˆ°åˆ†äº«è³‡æ–™ï¼š\n- é£Ÿæï¼š${data.ingredients?.length || 0} é …\n- é£Ÿè­œï¼š${data.recipes?.length || 0} é …\n\né»é¸ã€Œç¢ºå®šã€åˆä½µè³‡æ–™ï¼ˆä¿ç•™ç¾æœ‰ï¼‰\né»é¸ã€Œå–æ¶ˆã€è¦†è“‹è³‡æ–™ï¼ˆæ¸…ç©ºç¾æœ‰ï¼‰`);
                
                if (mode) {
                    // åˆä½µæ¨¡å¼
                    if (data.ingredients) {
                        data.ingredients.forEach(ing => {
                            // é‡æ–°ç”Ÿæˆ ID é¿å…è¡çª
                            const newIng = { ...ing, id: Date.now() + Math.random() };
                            state.ingredients.push(newIng);
                        });
                    }
                    if (data.recipes) {
                        data.recipes.forEach(recipe => {
                            const newRecipe = { ...recipe, id: Date.now() + Math.random() };
                            state.recipes.push(newRecipe);
                        });
                    }
                } else {
                    // è¦†è“‹æ¨¡å¼
                    if (data.ingredients) state.ingredients = data.ingredients;
                    if (data.recipes) state.recipes = data.recipes;
                }

                saveData();
                renderCurrentView();
                document.getElementById('import-share-code').value = '';
                alert('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
            } catch (error) {
                alert('è³‡æ–™è§£æå¤±æ•—ï¼š' + error.message);
            }
        }

        // è‡ªå‹•è¨ˆç®—é›£æ˜“åº¦
        function autoCalculateDifficulty() {
            const form = document.getElementById('recipe-form');
            if (!form) return;
            
            // æ”¶é›†é£Ÿæå’Œæ­¥é©Ÿæ•¸é‡
            const ingredientsCount = document.querySelectorAll('[data-type="ingredients"]').length / 5; // æ¯å€‹é£Ÿæ5å€‹æ¬„ä½
            const seasoningsCount = document.querySelectorAll('[data-type="seasonings"]').length / 5;
            const stepsCount = document.querySelectorAll('[data-type="steps"]').length / 2; // æ¯å€‹æ­¥é©Ÿ2å€‹æ¬„ä½
            
            const totalItems = ingredientsCount + seasoningsCount;
            
            // åˆ†ææ­¥é©Ÿè¤‡é›œåº¦
            let complexity = 0;
            document.querySelectorAll('[data-type="steps"] textarea').forEach(textarea => {
                const text = textarea.value.toLowerCase();
                // è¤‡é›œçƒ¹é£ªè©å½™
                if (text.match(/ç‡‰|ç…®|è’¸|çƒ¤|ç‚¸|é†ƒ|ç™¼é…µ|æ‰éºµ|æ¡¿éºµ|åˆ‡çµ²|åˆ‡ç‰‡|åˆ‡ä¸/)) complexity += 0.5;
                if (text.match(/åˆ†é˜|å°æ™‚|éœç½®|å†·è—|å†·å‡|é†’éºµ/)) complexity += 0.3;
                if (text.length > 50) complexity += 0.2;
            });
            
            // è¨ˆç®—é›£æ˜“åº¦ (1-5)
            let difficulty = 1;
            
            if (totalItems > 15 || stepsCount > 8 || complexity > 5) {
                difficulty = 5;
            } else if (totalItems > 10 || stepsCount > 6 || complexity > 3) {
                difficulty = 4;
            } else if (totalItems > 7 || stepsCount > 4 || complexity > 2) {
                difficulty = 3;
            } else if (totalItems > 4 || stepsCount > 2 || complexity > 1) {
                difficulty = 2;
            }
            
            document.getElementById('difficulty-select').value = difficulty;
            alert(`è‡ªå‹•è©•ä¼°å®Œæˆï¼\n\né£Ÿæ/èª¿å‘³æ–™ï¼š${Math.floor(totalItems)} é …\næ­¥é©Ÿæ•¸ï¼š${Math.floor(stepsCount)} æ­¥\nè¤‡é›œåº¦æŒ‡æ•¸ï¼š${complexity.toFixed(1)}\n\nå»ºè­°é›£æ˜“åº¦ï¼š${'â­'.repeat(difficulty)}`);
        }

        // åˆ‡æ›è¼¸å…¥æ¨¡å¼
        function switchInputMode(mode) {
            const theme = THEMES[state.currentSeason];
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            ['text', 'url', 'image'].forEach(m => {
                const btn = document.getElementById(`input-mode-${m}`);
                if (btn) {
                    if (m === mode) {
                        btn.style.backgroundColor = theme.primary + '20';
                    } else {
                        btn.style.backgroundColor = 'transparent';
                    }
                }
            });
            
            // é¡¯ç¤º/éš±è—å°æ‡‰å€åŸŸ
            document.getElementById('input-text-mode').classList.toggle('hidden', mode !== 'text');
            document.getElementById('input-url-mode').classList.toggle('hidden', mode !== 'url');
            document.getElementById('input-image-mode').classList.toggle('hidden', mode !== 'image');
        }

        // è™•ç†åœ–ç‰‡ä¸Šå‚³
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('preview-img');
                img.src = e.target.result;
                document.getElementById('image-preview').classList.remove('hidden');
                
                // å„²å­˜åœ–ç‰‡æ•¸æ“šä¾› OCR ä½¿ç”¨
                window.uploadedImageData = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // é£Ÿè­œæ•´ç†å™¨ - æ¸…ç©ºè¼¸å…¥
        function clearOrganizerInput() {
            document.getElementById('recipe-input').value = '';
            document.getElementById('recipe-url').value = '';
            document.getElementById('recipe-image').value = '';
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('organized-result').classList.add('hidden');
            window.uploadedImageData = null;
        }

        // é£Ÿè­œæ•´ç†å™¨ - æ•´ç†é£Ÿè­œ
        function organizeRecipe() {
            let input = '';
            let inputMode = 'text';
            
            // åˆ¤æ–·ç•¶å‰è¼¸å…¥æ¨¡å¼
            if (!document.getElementById('input-text-mode').classList.contains('hidden')) {
                input = document.getElementById('recipe-input').value.trim();
                inputMode = 'text';
            } else if (!document.getElementById('input-url-mode').classList.contains('hidden')) {
                input = document.getElementById('recipe-url').value.trim();
                inputMode = 'url';
            } else if (!document.getElementById('input-image-mode').classList.contains('hidden')) {
                inputMode = 'image';
                input = window.uploadedImageData;
            }
            
            if (!input) {
                alert('è«‹è¼¸å…¥é£Ÿè­œå…§å®¹ã€ç¶²å€æˆ–ä¸Šå‚³åœ–ç‰‡ï¼');
                return;
            }

            // é¡¯ç¤ºè™•ç†ä¸­
            const resultDiv = document.getElementById('organized-result');
            const previewDiv = document.getElementById('organized-preview');
            resultDiv.classList.remove('hidden');
            
            if (inputMode === 'url') {
                previewDiv.innerHTML = '<div class="text-center py-8"><div class="text-4xl mb-2">ğŸ”—</div><p>æ­£åœ¨å¾ç¶²å€æŠ“å–é£Ÿè­œå…§å®¹...</p><p class="text-sm opacity-70 mt-2">ï¼ˆå¯¦éš›æ‡‰ç”¨éœ€æ­é…å¾Œç«¯ APIï¼‰</p></div>';
                setTimeout(() => {
                    alert('ç¶²å€æ¨¡å¼éœ€è¦å¾Œç«¯ API æ”¯æ´ï¼Œ\né€™è£¡æä¾›ç¯„ä¾‹å±•ç¤ºã€‚\n\nè«‹æ”¹ç”¨ã€Œæ–‡å­—è¼¸å…¥ã€æ¨¡å¼ï¼Œ\nç›´æ¥è²¼ä¸Šå¾ç¶²ç«™è¤‡è£½çš„é£Ÿè­œå…§å®¹ã€‚');
                    previewDiv.innerHTML = '<div class="text-center py-8 opacity-50"><p>è«‹ä½¿ç”¨ã€Œæ–‡å­—è¼¸å…¥ã€æ¨¡å¼</p></div>';
                }, 1500);
                return;
            }
            
            if (inputMode === 'image') {
                previewDiv.innerHTML = '<div class="text-center py-8"><div class="text-4xl mb-2">ğŸ“·</div><p>æ­£åœ¨é€²è¡Œ OCR æ–‡å­—è¾¨è­˜...</p><p class="text-sm opacity-70 mt-2">ï¼ˆå¯¦éš›æ‡‰ç”¨éœ€æ­é… OCR APIï¼Œå¦‚ Tesseract.js æˆ– Google Cloud Visionï¼‰</p></div>';
                setTimeout(() => {
                    alert('åœ–ç‰‡ OCR åŠŸèƒ½éœ€è¦ API æ”¯æ´ï¼Œ\né€™è£¡æä¾›ç¯„ä¾‹å±•ç¤ºã€‚\n\nå»ºè­°ä½¿ç”¨æ­¥é©Ÿï¼š\n1. ä½¿ç”¨æ‰‹æ©Ÿ OCR å·¥å…·è¾¨è­˜åœ–ç‰‡æ–‡å­—\n2. å°‡è¾¨è­˜çµæœè¤‡è£½åˆ°ã€Œæ–‡å­—è¼¸å…¥ã€æ¨¡å¼');
                    previewDiv.innerHTML = '<div class="text-center py-8 opacity-50"><p>è«‹å°‡ OCR çµæœè²¼åˆ°ã€Œæ–‡å­—è¼¸å…¥ã€æ¨¡å¼</p></div>';
                }, 1500);
                return;
            }

            // æ–‡å­—æ¨¡å¼ - æ­£å¸¸è™•ç†
            previewDiv.innerHTML = '<div class="text-center py-8"><div class="text-4xl mb-2">ğŸ¤–</div><p>AI æ­£åœ¨æ•´ç†é£Ÿè­œ...</p></div>';

            setTimeout(() => {
                const organized = parseRecipeText(input);
                displayOrganizedRecipe(organized);
            }, 1000);
        }

        // è§£æé£Ÿè­œæ–‡å­—ï¼ˆæ”¹é€²ç‰ˆï¼‰
        function parseRecipeText(text) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            
            const recipe = {
                name: '',
                servings: 2,
                difficulty: 0,
                cookingTime: 0,
                ingredients: [],
                seasonings: [],
                steps: []
            };

            let currentSection = 'unknown';
            
            // ç¬¬ä¸€æ­¥ï¼šè­˜åˆ¥é£Ÿè­œåç¨±å’Œäººä»½
            const firstLine = lines[0] || '';
            
            // æå–äººä»½æ•¸
            const servingsMatch = text.match(/(\d+)\s*[äººä»½]ä»½?/);
            if (servingsMatch) {
                recipe.servings = parseInt(servingsMatch[1]);
            }
            
            // æå–çƒ¹é£ªæ™‚é–“
            const timeMatch = text.match(/(\d+)\s*åˆ†é˜|(\d+)\s*å°æ™‚/);
            if (timeMatch) {
                recipe.cookingTime = timeMatch[1] ? parseInt(timeMatch[1]) : parseInt(timeMatch[2]) * 60;
            }
            
            // é£Ÿè­œåç¨±ï¼ˆç¬¬ä¸€è¡Œæˆ–æ¨™é¡Œï¼‰
            recipe.name = firstLine.replace(/ã€|ã€‘|\(.*?\)|\ï¼ˆ.*?\ï¼‰/g, '').replace(/\d+\s*[äººä»½]ä»½?/g, '').trim();
            if (!recipe.name || recipe.name.length > 30) {
                recipe.name = 'æœªå‘½åé£Ÿè­œ';
            }

            // ç¬¬äºŒæ­¥ï¼šé€è¡Œè§£æ
            lines.forEach((line, index) => {
                if (index === 0) return; // è·³éç¬¬ä¸€è¡Œï¼ˆå·²è™•ç†ï¼‰
                
                const lineLower = line.toLowerCase();
                
                // åˆ¤æ–·å€å¡Šæ¨™é¡Œ
                if (lineLower.match(/^(é£Ÿæ|ææ–™|åŸæ–™|ä¸»ææ–™|é£Ÿæ–™|ingredients?)[:ï¼š]?$/)) {
                    currentSection = 'ingredients';
                    return;
                }
                if (lineLower.match(/^(èª¿å‘³æ–™?|é†¬æ±|èª¿æ–™|è¾›é¦™æ–™|seasonings?|sauce)[:ï¼š]?$/)) {
                    currentSection = 'seasonings';
                    return;
                }
                if (lineLower.match(/^(æ­¥é©Ÿ|åšæ³•|ä½œæ³•|æ–¹æ³•|è£½ä½œæ–¹æ³•|çƒ¹é£ªæ–¹æ³•|ç…®æ³•|æ–™ç†æ­¥é©Ÿ|steps?|cooking|instructions?)[:ï¼š]?$/)) {
                    currentSection = 'steps';
                    return;
                }
                
                // è§£æå…§å®¹
                if (currentSection === 'ingredients' || currentSection === 'seasonings') {
                    const item = parseIngredientLine(line);
                    if (item) {
                        if (currentSection === 'ingredients') {
                            recipe.ingredients.push(item);
                        } else {
                            recipe.seasonings.push(item);
                        }
                    }
                } else if (currentSection === 'steps') {
                    const step = parseStepLine(line);
                    if (step) {
                        recipe.steps.push(step);
                    }
                } else if (currentSection === 'unknown') {
                    // å˜—è©¦è‡ªå‹•åˆ¤æ–·ï¼ˆæœªæ˜ç¢ºæ¨™ç¤ºå€å¡Šæ™‚ï¼‰
                    if (lineLower.match(/é£Ÿæ|ææ–™|ä¸»ææ–™/)) {
                        currentSection = 'ingredients';
                    } else if (lineLower.match(/èª¿å‘³|é†¬æ±/)) {
                        currentSection = 'seasonings';
                    } else if (lineLower.match(/æ­¥é©Ÿ|åšæ³•|ä½œæ³•|æ–¹æ³•|è£½ä½œ/)) {
                        currentSection = 'steps';
                    }
                }
            });

            // å¦‚æœæ²’æœ‰æ˜ç¢ºå€åˆ†ï¼Œå˜—è©¦æ™ºæ…§åˆ†é¡
            if (recipe.ingredients.length === 0 && recipe.seasonings.length === 0 && recipe.steps.length === 0) {
                autoClassifyRecipe(text, recipe);
            }

            // ç¢ºä¿è‡³å°‘æœ‰åŸºæœ¬è³‡æ–™
            if (recipe.ingredients.length === 0) {
                recipe.ingredients.push({ 
                    name: '', 
                    amount: '', 
                    unit: INGREDIENT_UNITS[0], 
                    customUnit: '', 
                    brand: '', 
                    tips: '' 
                });
            }
            if (recipe.steps.length === 0) {
                recipe.steps.push({ text: '', tips: '' });
            }

            // è‡ªå‹•è©•ä¼°é›£æ˜“åº¦
            const totalItems = recipe.ingredients.length + recipe.seasonings.length;
            const stepsCount = recipe.steps.length;
            
            if (totalItems > 15 || stepsCount > 8) {
                recipe.difficulty = 5;
            } else if (totalItems > 10 || stepsCount > 6) {
                recipe.difficulty = 4;
            } else if (totalItems > 7 || stepsCount > 4) {
                recipe.difficulty = 3;
            } else if (totalItems > 4 || stepsCount > 2) {
                recipe.difficulty = 2;
            } else {
                recipe.difficulty = 1;
            }

            return recipe;
        }

        // è§£æé£Ÿæ/èª¿å‘³æ–™è¡Œ
        function parseIngredientLine(line) {
            // ç§»é™¤å‰å°ç¬¦è™Ÿ
            line = line.replace(/^[â€¢\-*Â·â–ªâ–«â—¦â€£âƒ]+\s*/, '').trim();
            if (!line) return null;
            
            // å¤šç¨®æ ¼å¼åŒ¹é…
            let name = '', amount = '', unit = '';
            
            // æ ¼å¼1: åç¨± æ•¸é‡å–®ä½ (ä¾‹å¦‚ï¼šé›èƒ¸è‚‰ 300gã€ç•ªèŒ„ 2å€‹)
            let match = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)\s*([a-zA-Zå…‹å…¬æ–¤å°æ–¤æ¯«å‡å…¬å‡å¤§å°åŒ™èŒ¶æ¹¯åŒ™é‡æ¯æ»´å€‹é¡†éš»æ ¹æ¢æ”¯ç‰‡ç“£æŠŠå¡Šè¢‹åŒ…é©é‡äº›è¨±]+)/);
            
            // æ ¼å¼2: åç¨±ï¼šæ•¸é‡å–®ä½ æˆ– åç¨± : æ•¸é‡å–®ä½
            if (!match) {
                match = line.match(/^(.+?)[:ï¼š]\s*(\d+(?:\.\d+)?)\s*([a-zA-Zå…‹å…¬æ–¤å°æ–¤æ¯«å‡å…¬å‡å¤§å°åŒ™èŒ¶æ¹¯åŒ™é‡æ¯æ»´å€‹é¡†éš»æ ¹æ¢æ”¯ç‰‡ç“£æŠŠå¡Šè¢‹åŒ…é©é‡äº›è¨±]+)/);
            }
            
            // æ ¼å¼3: æ•¸é‡å–®ä½ åç¨± (ä¾‹å¦‚ï¼š300g é›èƒ¸è‚‰)
            if (!match) {
                match = line.match(/^(\d+(?:\.\d+)?)\s*([a-zA-Zå…‹å…¬æ–¤å°æ–¤æ¯«å‡å…¬å‡å¤§å°åŒ™èŒ¶æ¹¯åŒ™é‡æ¯æ»´å€‹é¡†éš»æ ¹æ¢æ”¯ç‰‡ç“£æŠŠå¡Šè¢‹åŒ…é©é‡äº›è¨±]+)\s+(.+)/);
                if (match) {
                    amount = match[1];
                    unit = match[2];
                    name = match[3];
                }
            }
            
            // æ ¼å¼4: åç¨± é©é‡/å°‘è¨± (ä¾‹å¦‚ï¼šé¹½ é©é‡)
            if (!match) {
                match = line.match(/^(.+?)\s+(é©é‡|äº›è¨±|å°‘è¨±|å°‘é‡|è‹¥å¹²)/);
                if (match) {
                    name = match[1];
                    amount = '';
                    unit = 'é©é‡ (as needed)';
                }
            }
            
            // ä¸€èˆ¬æ ¼å¼è™•ç†
            if (match && !amount) {
                name = match[1].trim();
                amount = match[2];
                unit = match[3];
            }
            
            // å¦‚æœé‚„æ˜¯æ²’åŒ¹é…åˆ°ï¼Œå˜—è©¦åˆ†å‰²
            if (!name) {
                const parts = line.split(/\s+/);
                if (parts.length >= 2) {
                    name = parts[0];
                    const rest = parts.slice(1).join(' ');
                    const numMatch = rest.match(/(\d+(?:\.\d+)?)/);
                    if (numMatch) {
                        amount = numMatch[1];
                        unit = rest.replace(numMatch[1], '').trim() || 'å€‹ / é¡† / éš» (pcs.)';
                    } else {
                        unit = rest || 'é©é‡ (as needed)';
                    }
                } else {
                    name = line;
                    unit = 'é©é‡ (as needed)';
                }
            }
            
            // å–®ä½æ¨™æº–åŒ–
            unit = normalizeUnit(unit);
            
            return {
                name: name.trim(),
                amount: amount,
                unit: unit,
                customUnit: '',
                brand: '',
                tips: ''
            };
        }

        // æ¨™æº–åŒ–å–®ä½
        function normalizeUnit(unit) {
            const unitMap = {
                'å…‹': 'å…¬å…‹ (g)',
                'g': 'å…¬å…‹ (g)',
                'G': 'å…¬å…‹ (g)',
                'å…¬å…‹': 'å…¬å…‹ (g)',
                'å…¬æ–¤': 'å…¬æ–¤ (kg)',
                'kg': 'å…¬æ–¤ (kg)',
                'KG': 'å…¬æ–¤ (kg)',
                'å°æ–¤': 'å°æ–¤ (catty)',
                'æ–¤': 'å°æ–¤ (catty)',
                'ml': 'æ¯«å‡ (ml)',
                'ML': 'æ¯«å‡ (ml)',
                'æ¯«å‡': 'æ¯«å‡ (ml)',
                'cc': 'æ¯«å‡ (ml)',
                'CC': 'æ¯«å‡ (ml)',
                'å…¬å‡': 'å…¬å‡ (L)',
                'l': 'å…¬å‡ (L)',
                'L': 'å…¬å‡ (L)',
                'å¤§åŒ™': 'å¤§åŒ™ (tbsp/T.) â‰ˆ15ml',
                'æ¹¯åŒ™': 'å¤§åŒ™ (tbsp/T.) â‰ˆ15ml',
                'tbsp': 'å¤§åŒ™ (tbsp/T.) â‰ˆ15ml',
                'T': 'å¤§åŒ™ (tbsp/T.) â‰ˆ15ml',
                'å°åŒ™': 'å°åŒ™ (tsp/t.) â‰ˆ5ml',
                'èŒ¶åŒ™': 'å°åŒ™ (tsp/t.) â‰ˆ5ml',
                'tsp': 'å°åŒ™ (tsp/t.) â‰ˆ5ml',
                't': 'å°åŒ™ (tsp/t.) â‰ˆ5ml',
                'é‡æ¯': 'é‡æ¯ (cup) â‰ˆ240ml',
                'æ¯': 'é‡æ¯ (cup) â‰ˆ240ml',
                'cup': 'é‡æ¯ (cup) â‰ˆ240ml',
                'æ»´': 'æ»´ (drop)',
                'drop': 'æ»´ (drop)',
                'å€‹': 'å€‹ / é¡† / éš» (pcs.)',
                'é¡†': 'å€‹ / é¡† / éš» (pcs.)',
                'éš»': 'å€‹ / é¡† / éš» (pcs.)',
                'åª': 'å€‹ / é¡† / éš» (pcs.)',
                'ç²’': 'å€‹ / é¡† / éš» (pcs.)',
                'æ ¹': 'æ ¹ / æ¢ / æ”¯ (stalk/strip)',
                'æ¢': 'æ ¹ / æ¢ / æ”¯ (stalk/strip)',
                'æ”¯': 'æ ¹ / æ¢ / æ”¯ (stalk/strip)',
                'ç‰‡': 'ç‰‡ (slice)',
                'ç“£': 'ç“£ (clove)',
                'æŠŠ': 'æŠŠ (bunch/handful)',
                'æŸ': 'æŠŠ (bunch/handful)',
                'å¡Š': 'å¡Š (block/chunk)',
                'è¢‹': 'è¢‹ / åŒ… (pack/bag)',
                'åŒ…': 'è¢‹ / åŒ… (pack/bag)',
                'é©é‡': 'é©é‡ (as needed)',
                'äº›è¨±': 'äº›è¨± (pinch)',
                'å°‘è¨±': 'äº›è¨± (pinch)',
                'å°‘é‡': 'äº›è¨± (pinch)',
                'è‹¥å¹²': 'é©é‡ (as needed)'
            };
            
            for (const [key, value] of Object.entries(unitMap)) {
                if (unit.includes(key)) {
                    return value;
                }
            }
            
            return unit || 'é©é‡ (as needed)';
        }

        // è§£ææ­¥é©Ÿè¡Œ
        function parseStepLine(line) {
            // ç§»é™¤æ­¥é©Ÿç·¨è™Ÿ
            line = line.replace(/^[â€¢\-*Â·â–ªâ–«â—¦â€£âƒ]+\s*/, '').trim();
            line = line.replace(/^(?:step|æ­¥é©Ÿ|æ­¥éª¤)?\s*[\dä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾]+[ã€.:ï¼š)ï¼‰]\s*/i, '').trim();
            
            if (!line) return null;
            
            return {
                text: line,
                tips: ''
            };
        }

        // è‡ªå‹•åˆ†é¡é£Ÿè­œï¼ˆç•¶æ²’æœ‰æ˜ç¢ºæ¨™ç¤ºæ™‚ï¼‰
        function autoClassifyRecipe(text, recipe) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            
            lines.forEach((line, index) => {
                if (index === 0) return; // è·³éæ¨™é¡Œ
                
                // å˜—è©¦åˆ¤æ–·æ˜¯é£Ÿæé‚„æ˜¯æ­¥é©Ÿ
                if (line.match(/^\d+[\.)ã€]/) || line.match(/^(step|æ­¥é©Ÿ)/i)) {
                    // çœ‹èµ·ä¾†åƒæ­¥é©Ÿ
                    const step = parseStepLine(line);
                    if (step) recipe.steps.push(step);
                } else {
                    // å˜—è©¦ä½œç‚ºé£Ÿæè§£æ
                    const item = parseIngredientLine(line);
                    if (item && item.name) {
                        // åˆ¤æ–·æ˜¯é£Ÿæé‚„æ˜¯èª¿å‘³æ–™ï¼ˆç°¡å–®è¦å‰‡ï¼‰
                        if (item.name.match(/é†¬|æ²¹|é¹½|ç³–|é†‹|é…’|ç²‰|æ–™|å‘³|èƒ¡æ¤’|è¾£æ¤’ç²‰|å…«è§’|æ¡‚/)) {
                            recipe.seasonings.push(item);
                        } else {
                            recipe.ingredients.push(item);
                        }
                    }
                }
            });
        }
        function parseRecipeText(text) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            
            const recipe = {
                name: '',
                servings: 2,
                difficulty: 0,
                cookingTime: 0,
                ingredients: [],
                seasonings: [],
                steps: []
            };

            let currentSection = 'name';
            let stepCounter = 0;

            lines.forEach((line, index) => {
                // é£Ÿè­œåç¨±ï¼ˆç¬¬ä¸€è¡Œæˆ–åŒ…å«ç‰¹å®šæ¨™é¡Œï¼‰
                if (index === 0 || line.match(/^ã€.*ã€‘$/) || (line.length < 20 && !line.match(/[:ï¼š]/))) {
                    recipe.name = line.replace(/ã€|ã€‘/g, '').trim();
                    return;
                }

                // åˆ¤æ–·å€å¡Š
                if (line.match(/é£Ÿæ|ææ–™|ingredients/i)) {
                    currentSection = 'ingredients';
                    return;
                }
                if (line.match(/èª¿å‘³|é†¬æ±|sauce|seasoning/i)) {
                    currentSection = 'seasonings';
                    return;
                }
                if (line.match(/æ­¥é©Ÿ|åšæ³•|ä½œæ³•|æ–¹æ³•|è£½ä½œ|æ–™ç†|cooking|æ­¥éª¤/i)) {
                    currentSection = 'steps';
                    return;
                }

                // è§£æå…§å®¹
                if (currentSection === 'ingredients' || currentSection === 'seasonings') {
                    const match = line.match(/^[â€¢\-*]?\s*(.+?)[ï¼š:]\s*(.+)/) || 
                                  line.match(/^[â€¢\-*]?\s*(.+?)\s+(\d+[\d.\s]*(?:å…‹|g|å…¬å…‹|å€‹|é¡†|æ ¹|æ¢|ç‰‡|å¤§åŒ™|å°åŒ™|ml|é©é‡|äº›è¨±).*)/) ||
                                  line.match(/^[â€¢\-*]?\s*(.+?)\s+(.+)$/);
                    
                    if (match) {
                        const name = match[1].trim();
                        const amountText = match[2].trim();
                        
                        // è§£ææ•¸é‡å’Œå–®ä½
                        const amountMatch = amountText.match(/^(\d+[\d.]*)\s*(.*)/) || ['', '', amountText];
                        const amount = amountMatch[1] || '';
                        let unit = amountMatch[2] || 'é©é‡ (as needed)';
                        
                        // å–®ä½å°æ‡‰
                        const unitMap = {
                            'å…‹': 'å…¬å…‹ (g)', 'g': 'å…¬å…‹ (g)', 'å…¬å…‹': 'å…¬å…‹ (g)',
                            'å€‹': 'å€‹ / é¡† / éš» (pcs.)', 'é¡†': 'å€‹ / é¡† / éš» (pcs.)',
                            'æ ¹': 'æ ¹ / æ¢ / æ”¯ (stalk/strip)', 'æ¢': 'æ ¹ / æ¢ / æ”¯ (stalk/strip)',
                            'ç‰‡': 'ç‰‡ (slice)',
                            'å¤§åŒ™': 'å¤§åŒ™ (tbsp/T.) â‰ˆ15ml', 'å°åŒ™': 'å°åŒ™ (tsp/t.) â‰ˆ5ml',
                            'tbsp': 'å¤§åŒ™ (tbsp/T.) â‰ˆ15ml', 'tsp': 'å°åŒ™ (tsp/t.) â‰ˆ5ml',
                            'ml': 'æ¯«å‡ (ml)', 'æ¯«å‡': 'æ¯«å‡ (ml)',
                            'é©é‡': 'é©é‡ (as needed)', 'äº›è¨±': 'äº›è¨± (pinch)'
                        };
                        
                        Object.keys(unitMap).forEach(key => {
                            if (unit.includes(key)) {
                                unit = unitMap[key];
                            }
                        });

                        const item = {
                            name: name,
                            amount: amount,
                            unit: unit,
                            customUnit: '',
                            brand: '',
                            tips: ''
                        };

                        if (currentSection === 'ingredients') {
                            recipe.ingredients.push(item);
                        } else {
                            recipe.seasonings.push(item);
                        }
                    }
                } else if (currentSection === 'steps') {
                    // ç§»é™¤æ­¥é©Ÿç·¨è™Ÿ
                    let stepText = line.replace(/^[â€¢\-*]?\s*(?:step|æ­¥é©Ÿ|æ­¥éª¤)?\s*[\dä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+[ã€.:ï¼š)]\s*/i, '').trim();
                    
                    if (stepText) {
                        stepCounter++;
                        recipe.steps.push({
                            text: stepText,
                            tips: ''
                        });
                    }
                }
            });

            // ç¢ºä¿è‡³å°‘æœ‰åŸºæœ¬è³‡æ–™
            if (!recipe.name) recipe.name = 'æœªå‘½åé£Ÿè­œ';
            if (recipe.ingredients.length === 0) {
                recipe.ingredients.push({ name: '', amount: '', unit: INGREDIENT_UNITS[0], customUnit: '', brand: '', tips: '' });
            }
            if (recipe.seasonings.length === 0) {
                recipe.seasonings.push({ name: '', amount: '', unit: SEASONING_UNITS[0], customUnit: '', brand: '', tips: '' });
            }
            if (recipe.steps.length === 0) {
                recipe.steps.push({ text: '', tips: '' });
            }

            // è‡ªå‹•è©•ä¼°é›£æ˜“åº¦
            const totalItems = recipe.ingredients.length + recipe.seasonings.length;
            const stepsCount = recipe.steps.length;
            
            if (totalItems > 15 || stepsCount > 8) {
                recipe.difficulty = 5;
            } else if (totalItems > 10 || stepsCount > 6) {
                recipe.difficulty = 4;
            } else if (totalItems > 7 || stepsCount > 4) {
                recipe.difficulty = 3;
            } else if (totalItems > 4 || stepsCount > 2) {
                recipe.difficulty = 2;
            } else {
                recipe.difficulty = 1;
            }

            return recipe;
        }

        // é¡¯ç¤ºæ•´ç†å¾Œçš„é£Ÿè­œ
        function displayOrganizedRecipe(recipe) {
            const theme = THEMES[state.currentSeason];
            
            const html = `
                <div style="background-color: ${theme.background}; padding: 1.5rem; border-radius: 0.75rem;">
                    <h4 class="font-bold text-2xl mb-4" style="color: ${theme.primary};">${recipe.name}</h4>
                    
                    <div class="mb-4 pb-4 border-b" style="border-color: ${theme.primary}30;">
                        <div class="grid grid-2 gap-4 text-sm">
                            <div><strong>äººä»½æ•¸ï¼š</strong>${recipe.servings} äººä»½</div>
                            <div><strong>é›£æ˜“åº¦ï¼š</strong>${'â­'.repeat(recipe.difficulty)}</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h5 class="font-bold mb-2 flex items-center gap-2">
                            <span>ğŸ¥˜</span> é£Ÿæ (${recipe.ingredients.length})
                        </h5>
                        <div class="space-y-1 text-sm">
                            ${recipe.ingredients.map(ing => `
                                <div class="flex justify-between">
                                    <span>${ing.name}</span>
                                    <span style="color: ${theme.primary};">${ing.amount} ${ing.unit}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    ${recipe.seasonings.length > 0 && recipe.seasonings[0].name ? `
                    <div class="mb-4">
                        <h5 class="font-bold mb-2 flex items-center gap-2">
                            <span>ğŸ§‚</span> èª¿å‘³æ–™ (${recipe.seasonings.length})
                        </h5>
                        <div class="space-y-1 text-sm">
                            ${recipe.seasonings.map(s => `
                                <div class="flex justify-between">
                                    <span>${s.name}</span>
                                    <span style="color: ${theme.secondary};">${s.amount} ${s.unit}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <div>
                        <h5 class="font-bold mb-2 flex items-center gap-2">
                            <span>ğŸ‘¨â€ğŸ³</span> æ­¥é©Ÿ (${recipe.steps.length})
                        </h5>
                        <div class="space-y-2 text-sm">
                            ${recipe.steps.map((step, idx) => `
                                <div class="flex gap-2">
                                    <span class="font-bold" style="color: ${theme.primary};">${idx + 1}.</span>
                                    <span>${step.text}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('organized-preview').innerHTML = html;
            
            // å„²å­˜åˆ°è‡¨æ™‚è®Šæ•¸
            window.tempOrganizedRecipe = recipe;
        }

        // ç·¨è¼¯æ•´ç†å¾Œçš„é£Ÿè­œ
        function editOrganizedRecipe() {
            if (!window.tempOrganizedRecipe) return;
            
            // å°‡æ•´ç†å¾Œçš„è³‡æ–™è‡¨æ™‚å­˜ç‚ºç·¨è¼¯ç‹€æ…‹
            window.editingTempRecipe = window.tempOrganizedRecipe;
            openRecipeForm(null);
        }

        // å„²å­˜æ•´ç†å¾Œçš„é£Ÿè­œ
        function saveOrganizedRecipe() {
            if (!window.tempOrganizedRecipe) return;
            
            const recipe = {
                ...window.tempOrganizedRecipe,
                id: Date.now()
            };

            state.recipes.push(recipe);
            saveData();
            
            alert('é£Ÿè­œå·²æˆåŠŸå„²å­˜åˆ°é£Ÿè­œåº«ï¼');
            setView('recipes');
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
